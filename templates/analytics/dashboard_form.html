{% extends 'base.html' %}

{% block title %}{% if object %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å {{ object.name }}{% else %}–°–æ–∑–¥–∞—Ç—å –¥–∞—à–±–æ—Ä–¥{% endif %} - Datum{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1 class="h2">
            <i class="bi bi-graph-up"></i>
            {% if object %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å: {{ object.name }}{% else %}–°–æ–∑–¥–∞—Ç—å –¥–∞—à–±–æ—Ä–¥{% endif %}
        </h1>
    </div>
</div>

<form method="post" id="dashboardForm">
    {% csrf_token %}

    <div class="row">
        <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å: –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
                </div>
                <div class="card-body">
                    {% if form.non_field_errors %}
                    <div class="alert alert-danger">{{ form.non_field_errors }}</div>
                    {% endif %}

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{{ form.name.label }} <span class="text-danger">*</span></label>
                            {{ form.name }}
                            {% if form.name.errors %}
                            <div class="invalid-feedback d-block">{{ form.name.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">{{ form.code.label }} <span class="text-danger">*</span></label>
                            {{ form.code }}
                            {% if form.code.errors %}
                            <div class="invalid-feedback d-block">{{ form.code.errors }}</div>
                            {% endif %}
                            <small class="form-text text-muted">–õ–∞—Ç–∏–Ω–∏—Ü–µ–π, –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤</small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">{{ form.description.label }}</label>
                        {{ form.description }}
                        {% if form.description.errors %}
                        <div class="invalid-feedback d-block">{{ form.description.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label class="form-label">{{ form.dashboard_type.label }} <span class="text-danger">*</span></label>
                        {{ form.dashboard_type }}
                        {% if form.dashboard_type.errors %}
                        <div class="invalid-feedback d-block">{{ form.dashboard_type.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –¥–∞—à–±–æ—Ä–¥–∞</small>
                    </div>

                    <div class="form-check">
                        {{ form.is_active }}
                        <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                            {{ form.is_active.label }}
                        </label>
                    </div>
                </div>
            </div>

            <!-- –í–∏–∑—É–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –≤–∏–¥–∂–µ—Ç–æ–≤ -->
            <div class="card">
                <div class="card-header bg-info text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-grid-3x3"></i> –í–∏–¥–∂–µ—Ç—ã –¥–∞—à–±–æ—Ä–¥–∞</h5>
                        <button type="button" class="btn btn-light btn-sm" onclick="addWidget()">
                            <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –≤–∏–¥–∂–µ—Ç
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="widgetsContainer">
                        <!-- –í–∏–¥–∂–µ—Ç—ã –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —Å—é–¥–∞ -->
                    </div>

                    <div id="emptyState" class="text-center py-5 text-muted">
                        <i class="bi bi-graph-up" style="font-size: 4rem;"></i>
                        <p class="mt-3">–ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –≤–∏–¥–∂–µ—Ç" —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</p>
                    </div>
                </div>
            </div>

            <!-- –î–æ—Å—Ç—É–ø –∫ –¥–∞—à–±–æ—Ä–¥—É -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-shield-lock"></i> –î–æ—Å—Ç—É–ø</h5>
                </div>
                <div class="card-body">
                    <div class="form-check mb-3">
                        {{ form.is_public }}
                        <label class="form-check-label" for="{{ form.is_public.id_for_label }}">
                            {{ form.is_public.label }}
                        </label>
                        <small class="form-text text-muted d-block">–ü—É–±–ª–∏—á–Ω—ã–π –¥–∞—à–±–æ—Ä–¥ –¥–æ—Å—Ç—É–ø–µ–Ω –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">{{ form.shared_with.label }}</label>
                        {{ form.shared_with }}
                        {% if form.shared_with.errors %}
                        <div class="invalid-feedback d-block">{{ form.shared_with.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —Å –∫–æ—Ç–æ—Ä—ã–º–∏ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –¥–∞—à–±–æ—Ä–¥–æ–º</small>
                    </div>
                </div>
            </div>

            <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è widgets_config -->
            <input type="hidden" name="widgets_config" id="configInput" value='{"widgets":[]}'>

            <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ -->
            <input type="hidden" name="default_filters" value="{}">
            <input type="hidden" name="refresh_interval" value="15">
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å: –î–µ–π—Å—Ç–≤–∏—è –∏ –ø—Ä–µ–≤—å—é -->
        <div class="col-lg-4">
            <div class="card sticky-top" style="top: 20px;">
                <div class="card-header bg-light">
                    <h5 class="mb-0">–î–µ–π—Å—Ç–≤–∏—è</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="bi bi-check-circle"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </button>
                        <a href="{% if object %}{% url 'analytics:dashboard_detail' object.pk %}{% else %}{% url 'analytics:dashboard_list' %}{% endif %}"
                           class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> –û—Ç–º–µ–Ω–∞
                        </a>
                    </div>
                </div>

                <div class="card-footer">
                    <small class="text-muted">
                        <strong>–¢–∏–ø—ã –≤–∏–¥–∂–µ—Ç–æ–≤:</strong><br>
                        ‚Ä¢ –ú–µ—Ç—Ä–∏–∫–∞ - –æ–¥–Ω–æ —á–∏—Å–ª–æ<br>
                        ‚Ä¢ –ì—Ä–∞—Ñ–∏–∫ - –ª–∏–Ω–µ–π–Ω—ã–π/—Å—Ç–æ–ª–±—á–∞—Ç—ã–π
                    </small>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤–∏–¥–∂–µ—Ç–∞ -->
<div class="modal fade" id="widgetModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle"></i> –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –≤–∏–¥–∂–µ—Ç–∞
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="widgetModalBody">
                <!-- –≠—Ç–∞–ø 1: –í—ã–±–æ—Ä —Ç–∏–ø–∞ –≤–∏–¥–∂–µ—Ç–∞ (–∫–∞—Ä—Ç–æ—á–∫–∏) -->
                <div id="widgetTypeSelection">
                    <div class="row g-3">
                        <!-- –ú–µ—Ç—Ä–∏–∫–∞ -->
                        <div class="col-md-4">
                            <div class="card widget-type-card h-100" onclick="selectWidgetType('metric')" style="cursor: pointer;">
                                <div class="card-body text-center">
                                    <div class="display-1 text-primary mb-3">üìä</div>
                                    <h5 class="card-title">–ú–µ—Ç—Ä–∏–∫–∞</h5>
                                    <p class="card-text text-muted small">–û–¥–Ω–æ –±–æ–ª—å—à–æ–µ —á–∏—Å–ª–æ —Å –∏–∫–æ–Ω–∫–æ–π. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏—Ç–æ–≥–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.</p>
                                    <div class="border rounded p-2 bg-light mt-3">
                                        <small class="text-muted">–ü—Ä–∏–º–µ—Ä:</small>
                                        <div class="fw-bold text-primary fs-3">80 —à—Ç</div>
                                        <small class="text-muted">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–ª–µ—Ü</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- –õ–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ -->
                        <div class="col-md-4">
                            <div class="card widget-type-card h-100" onclick="selectWidgetType('line')" style="cursor: pointer;">
                                <div class="card-body text-center">
                                    <div class="display-1 text-success mb-3">üìà</div>
                                    <h5 class="card-title">–õ–∏–Ω–µ–π–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫</h5>
                                    <p class="card-text text-muted small">–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç—Ä–µ–Ω–¥—ã –∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–æ –≤—Ä–µ–º–µ–Ω–∏.</p>
                                    <div class="border rounded p-2 bg-light mt-3">
                                        <small class="text-muted">–ü—Ä–∏–º–µ—Ä: –¥–∏–Ω–∞–º–∏–∫–∞ –ø—Ä–æ–¥–∞–∂</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- –°—Ç–æ–ª–±—á–∞—Ç—ã–π –≥—Ä–∞—Ñ–∏–∫ -->
                        <div class="col-md-4">
                            <div class="card widget-type-card h-100" onclick="selectWidgetType('bar')" style="cursor: pointer;">
                                <div class="card-body text-center">
                                    <div class="display-1 text-info mb-3">üìä</div>
                                    <h5 class="card-title">–°—Ç–æ–ª–±—á–∞—Ç—ã–π –≥—Ä–∞—Ñ–∏–∫</h5>
                                    <p class="card-text text-muted small">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º.</p>
                                    <div class="border rounded p-2 bg-light mt-3">
                                        <small class="text-muted">–ü—Ä–∏–º–µ—Ä: —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- –ö—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ -->
                        <div class="col-md-4">
                            <div class="card widget-type-card h-100" onclick="selectWidgetType('pie')" style="cursor: pointer;">
                                <div class="card-body text-center">
                                    <div class="display-1 text-warning mb-3">ü•ß</div>
                                    <h5 class="card-title">–ö—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞</h5>
                                    <p class="card-text text-muted small">–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–æ–ª–∏ –æ—Ç —Ü–µ–ª–æ–≥–æ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö.</p>
                                    <div class="border rounded p-2 bg-light mt-3">
                                        <small class="text-muted">–ü—Ä–∏–º–µ—Ä: –¥–æ–ª–∏ –ø–æ —Ç–∏–ø–∞–º –∑–æ–ª–æ—Ç–∞</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- –ü–æ–Ω—á–∏–∫ -->
                        <div class="col-md-4">
                            <div class="card widget-type-card h-100" onclick="selectWidgetType('doughnut')" style="cursor: pointer;">
                                <div class="card-body text-center">
                                    <div class="display-1 text-danger mb-3">üç©</div>
                                    <h5 class="card-title">–î–∏–∞–≥—Ä–∞–º–º–∞-–ø–æ–Ω—á–∏–∫</h5>
                                    <p class="card-text text-muted small">–ö–∞–∫ –∫—Ä—É–≥–æ–≤–∞—è, –Ω–æ —Å –æ—Ç–≤–µ—Ä—Å—Ç–∏–µ–º –≤ —Ü–µ–Ω—Ç—Ä–µ.</p>
                                    <div class="border rounded p-2 bg-light mt-3">
                                        <small class="text-muted">–ü—Ä–∏–º–µ—Ä: —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- –†–∞–¥–∞—Ä -->
                        <div class="col-md-4">
                            <div class="card widget-type-card h-100" onclick="selectWidgetType('radar')" style="cursor: pointer;">
                                <div class="card-body text-center">
                                    <div class="display-1 text-primary mb-3">üï∏Ô∏è</div>
                                    <h5 class="card-title">–†–∞–¥–∞—Ä</h5>
                                    <p class="card-text text-muted small">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º.</p>
                                    <div class="border rounded p-2 bg-light mt-3">
                                        <small class="text-muted">–ü—Ä–∏–º–µ—Ä: –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –º–∞–≥–∞–∑–∏–Ω–∞</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- –ü–æ–ª—è—Ä–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ -->
                        <div class="col-md-4">
                            <div class="card widget-type-card h-100" onclick="selectWidgetType('polarArea')" style="cursor: pointer;">
                                <div class="card-body text-center">
                                    <div class="display-1 text-success mb-3">‚≠ï</div>
                                    <h5 class="card-title">–ü–æ–ª—è—Ä–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞</h5>
                                    <p class="card-text text-muted small">–ö—Ä—É–≥–æ–≤–∞—è —Å —Ä–∞–∑–º–µ—Ä–æ–º —Å–µ–≥–º–µ–Ω—Ç–æ–≤.</p>
                                    <div class="border rounded p-2 bg-light mt-3">
                                        <small class="text-muted">–ü—Ä–∏–º–µ—Ä: –æ–±—ä–µ–º—ã –ø–æ –∫–∞–Ω–∞–ª–∞–º</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π –±–∞—Ä -->
                        <div class="col-md-4">
                            <div class="card widget-type-card h-100" onclick="selectWidgetType('horizontalBar')" style="cursor: pointer;">
                                <div class="card-body text-center">
                                    <div class="display-1 text-info mb-3">üì∂</div>
                                    <h5 class="card-title">–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–æ–ª–±—Ü—ã</h5>
                                    <p class="card-text text-muted small">–°—Ç–æ–ª–±—Ü—ã —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω—ã –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ.</p>
                                    <div class="border rounded p-2 bg-light mt-3">
                                        <small class="text-muted">–ü—Ä–∏–º–µ—Ä: —Ä–µ–π—Ç–∏–Ω–≥ —Ç–æ—á–µ–∫</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- –¢–∞–±–ª–∏—Ü–∞ -->
                        <div class="col-md-4">
                            <div class="card widget-type-card h-100" onclick="selectWidgetType('table')" style="cursor: pointer;">
                                <div class="card-body text-center">
                                    <div class="display-1 text-secondary mb-3">üìã</div>
                                    <h5 class="card-title">–¢–∞–±–ª–∏—Ü–∞</h5>
                                    <p class="card-text text-muted small">–î–µ—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—á–Ω–æ–º –≤–∏–¥–µ.</p>
                                    <div class="border rounded p-2 bg-light mt-3">
                                        <small class="text-muted">–ü—Ä–∏–º–µ—Ä: —Ç–æ–ø-10 —Ç–æ—á–µ–∫</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –≠—Ç–∞–ø 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≤–∏–¥–∂–µ—Ç–∞ -->
                <div id="widgetConfigForm" style="display: none;">
                    <button type="button" class="btn btn-sm btn-outline-secondary mb-3" onclick="backToTypeSelection()">
                        <i class="bi bi-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ –≤—ã–±–æ—Ä—É —Ç–∏–ø–∞
                    </button>
                    <div id="widgetFormContainer"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" id="saveWidgetBtn" onclick="saveWidget()" style="display: none;">
                    <i class="bi bi-check-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –≤–∏–¥–∂–µ—Ç
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.widget-type-card {
    transition: all 0.3s ease;
    border: 2px solid transparent;
}
.widget-type-card:hover {
    border-color: var(--bs-primary);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transform: translateY(-5px);
}
</style>

<script>
// –°–∫—Ä–∏–ø—Ç –≤–Ω—É—Ç—Ä–∏ content (–±–ª–æ–∫ extra_js –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è)
console.log('=== INLINE SCRIPT LOADED ===');

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let widgets = [];
let editingIndex = null;
let allCoefficients = [];
let selectedWidgetType = null;

// –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
fetch('/api/coefficients/')
    .then(response => response.json())
    .then(data => {
        allCoefficients = data;
        console.log('‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤:', allCoefficients.length);
    })
    .catch(error => {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤:', error);
    });

// –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤–∏–¥–∂–µ—Ç–∞
window.addWidget = function() {
    console.log('addWidget() called');
    editingIndex = null;
    selectedWidgetType = null;

    // –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞
    document.getElementById('widgetTypeSelection').style.display = 'block';
    document.getElementById('widgetConfigForm').style.display = 'none';
    document.getElementById('saveWidgetBtn').style.display = 'none';

    const modalElement = document.getElementById('widgetModal');
    if (!modalElement) {
        console.error('Modal element not found');
        return;
    }
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
};

// –í—ã–±—Ä–∞—Ç—å —Ç–∏–ø –≤–∏–¥–∂–µ—Ç–∞
window.selectWidgetType = function(type) {
    console.log('Selected widget type:', type);
    selectedWidgetType = type;

    // –°–∫—Ä—ã—Ç—å –≤—ã–±–æ—Ä —Ç–∏–ø–∞, –ø–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    document.getElementById('widgetTypeSelection').style.display = 'none';
    document.getElementById('widgetConfigForm').style.display = 'block';
    document.getElementById('saveWidgetBtn').style.display = 'block';

    // –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ä–º—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
    updateWidgetForm(type);
};

// –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤—ã–±–æ—Ä—É —Ç–∏–ø–∞
window.backToTypeSelection = function() {
    document.getElementById('widgetTypeSelection').style.display = 'block';
    document.getElementById('widgetConfigForm').style.display = 'none';
    document.getElementById('saveWidgetBtn').style.display = 'none';
    selectedWidgetType = null;
};

// –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ä–º—É –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏–¥–∂–µ—Ç–∞
window.updateWidgetForm = function(type) {
    const container = document.getElementById('widgetFormContainer');

    if (!type) {
        container.innerHTML = '';
        return;
    }

    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ–ø—Ü–∏–π –¥–ª—è –≤—ã–±–æ—Ä–∞ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞
    const coefficientOptions = allCoefficients.map(c =>
        `<option value="${c.id}">${c.name} ${c.unit ? '(' + c.unit + ')' : ''} - [${c.data_type_display}]</option>`
    ).join('');

    const commonFields = `
        <div class="mb-3">
            <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="widgetTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≤–∏–¥–∂–µ—Ç–∞">
            <small class="text-muted">–ö–æ—Ä–æ—Ç–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</small>
        </div>
        <div class="mb-3">
            <label class="form-label">–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç/–ú–µ—Ç—Ä–∏–∫–∞ <span class="text-danger">*</span></label>
            <select class="form-select" id="widgetCoefficient">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç...</option>
                ${coefficientOptions}
            </select>
            <small class="text-muted">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</small>
        </div>
    `;

    if (type === 'metric') {
        container.innerHTML = `
            ${commonFields}
            <div class="mb-3">
                <label class="form-label">–§—É–Ω–∫—Ü–∏—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏</label>
                <select class="form-select" id="widgetAggregation">
                    <option value="avg">–°—Ä–µ–¥–Ω–µ–µ (AVG)</option>
                    <option value="sum">–°—É–º–º–∞ (SUM)</option>
                    <option value="count">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (COUNT)</option>
                    <option value="min">–ú–∏–Ω–∏–º—É–º (MIN)</option>
                    <option value="max">–ú–∞–∫—Å–∏–º—É–º (MAX)</option>
                </select>
                <small class="text-muted">–ö–∞–∫ –≤—ã—á–∏—Å–ª—è—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ</small>
            </div>
            <div class="mb-3">
                <label class="form-label">–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è</label>
                <input type="text" class="form-control" id="widgetUnit" placeholder="—à—Ç">
                <small class="text-muted">‚ÇΩ, %, —à—Ç, –∫–≥, –≥</small>
            </div>
            <div class="mb-3">
                <label class="form-label">–¶–≤–µ—Ç –∫–∞—Ä—Ç–æ—á–∫–∏</label>
                <select class="form-select" id="widgetColor">
                    <option value="primary">–°–∏–Ω–∏–π</option>
                    <option value="success">–ó–µ–ª–µ–Ω—ã–π</option>
                    <option value="danger">–ö—Ä–∞—Å–Ω—ã–π</option>
                    <option value="warning">–ñ–µ–ª—Ç—ã–π</option>
                    <option value="info">–ì–æ–ª—É–±–æ–π</option>
                </select>
            </div>
            <div class="alert alert-info small">
                üí° <strong>–¢–∏–ø –¥–∞–Ω–Ω—ã—Ö</strong> (–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–≤—ã–µ/–≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–µ/–ò–ò) –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –Ω–∞ –¥–∞—à–±–æ—Ä–¥–µ –ø—Ä–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ
            </div>
        `;
    } else if (['line', 'bar', 'horizontalBar'].includes(type)) {
        // –õ–∏–Ω–µ–π–Ω—ã–µ –∏ —Å—Ç–æ–ª–±—á–∞—Ç—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏
        container.innerHTML = `
            ${commonFields}
            <div class="mb-3">
                <label class="form-label">–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö</label>
                <select class="form-select" id="widgetGroupBy">
                    <option value="date">–ü–æ –¥–Ω—è–º</option>
                    <option value="week">–ü–æ –Ω–µ–¥–µ–ª—è–º</option>
                    <option value="month">–ü–æ –º–µ—Å—è—Ü–∞–º</option>
                    <option value="region">–ü–æ —Ä–µ–≥–∏–æ–Ω–∞–º</option>
                    <option value="channel">–ü–æ –∫–∞–Ω–∞–ª–∞–º</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">–¶–≤–µ—Ç</label>
                <input type="color" class="form-control form-control-color" id="widgetColor" value="#0d6efd">
            </div>
            <div class="alert alert-info small">
                üí° –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å—Å—è –∏ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ –≤–∏–¥–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ä—è–¥–∞ –∏–ª–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            </div>
        `;
    } else if (['pie', 'doughnut', 'polarArea'].includes(type)) {
        // –ö—Ä—É–≥–æ–≤—ã–µ –¥–∏–∞–≥—Ä–∞–º–º—ã
        container.innerHTML = `
            ${commonFields}
            <div class="mb-3">
                <label class="form-label">–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö</label>
                <select class="form-select" id="widgetGroupBy">
                    <option value="region">–ü–æ —Ä–µ–≥–∏–æ–Ω–∞–º</option>
                    <option value="channel">–ü–æ –∫–∞–Ω–∞–ª–∞–º</option>
                    <option value="outlet">–ü–æ —Ç–æ—Ä–≥–æ–≤—ã–º —Ç–æ—á–∫–∞–º</option>
                </select>
                <small class="text-muted">–î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–æ–∫–∞–∑–∞–Ω—ã –∫–∞–∫ –¥–æ–ª–∏ –æ—Ç —Ü–µ–ª–æ–≥–æ</small>
            </div>
            <div class="mb-3">
                <label class="form-label">–ú–∞–∫—Å–∏–º—É–º —Å–µ–≥–º–µ–Ω—Ç–æ–≤</label>
                <input type="number" class="form-control" id="widgetMaxSegments" value="5" min="3" max="10">
                <small class="text-muted">–°–∫–æ–ª—å–∫–æ –∫—Ä—É–ø–Ω–µ–π—à–∏—Ö —Å–µ–≥–º–µ–Ω—Ç–æ–≤ –ø–æ–∫–∞–∑–∞—Ç—å (–æ—Å—Ç–∞–ª—å–Ω—ã–µ –≤ "–ü—Ä–æ—á–∏–µ")</small>
            </div>
            <div class="alert alert-info small">
                üí° –ö—Ä—É–≥–æ–≤—ã–µ –¥–∏–∞–≥—Ä–∞–º–º—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
            </div>
        `;
    } else if (type === 'radar') {
        // –†–∞–¥–∞—Ä
        container.innerHTML = `
            <div class="mb-3">
                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="widgetTitle" placeholder="–ü—Ä–æ—Ñ–∏–ª—å –º–∞–≥–∞–∑–∏–Ω–∞">
            </div>
            <div class="mb-3">
                <label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–µ—Ç—Ä–∏–∫</label>
                <select class="form-select" id="widgetCoefficients" multiple size="8">
                    ${allCoefficients.map(c =>
                        `<option value="${c.id}">${c.name} (${c.unit || '–±–µ–∑ –µ–¥.'})</option>`
                    ).join('')}
                </select>
                <small class="text-muted">–£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ Ctrl –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞</small>
            </div>
            <div class="alert alert-info small">
                üí° –†–∞–¥–∞—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å –ø–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è–º –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
            </div>
        `;
    } else if (type === 'table') {
        // –¢–∞–±–ª–∏—Ü–∞
        container.innerHTML = `
            ${commonFields}
            <div class="mb-3">
                <label class="form-label">–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö</label>
                <select class="form-select" id="widgetGroupBy">
                    <option value="outlet">–ü–æ —Ç–æ—Ä–≥–æ–≤—ã–º —Ç–æ—á–∫–∞–º</option>
                    <option value="region">–ü–æ —Ä–µ–≥–∏–æ–Ω–∞–º</option>
                    <option value="channel">–ü–æ –∫–∞–Ω–∞–ª–∞–º</option>
                    <option value="date">–ü–æ –¥–Ω—è–º</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫</label>
                <input type="number" class="form-control" id="widgetRowLimit" value="10" min="5" max="50">
                <small class="text-muted">–°–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å (—Ç–æ–ø N)</small>
            </div>
            <div class="mb-3">
                <label class="form-label">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
                <select class="form-select" id="widgetSort">
                    <option value="desc">–ü–æ —É–±—ã–≤–∞–Ω–∏—é (–±–æ–ª—å—à–µ ‚Üí –º–µ–Ω—å—à–µ)</option>
                    <option value="asc">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é (–º–µ–Ω—å—à–µ ‚Üí –±–æ–ª—å—à–µ)</option>
                </select>
            </div>
            <div class="alert alert-info small">
                üí° –¢–∞–±–ª–∏—Ü–∞ –ø–æ–∫–∞–∂–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
            </div>
        `;
    }
};

// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤–∏–¥–∂–µ—Ç
window.saveWidget = function() {
    const type = selectedWidgetType;
    const title = document.getElementById('widgetTitle')?.value;

    if (!type || !title) {
        alert('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: –Ω–∞–∑–≤–∞–Ω–∏–µ');
        return;
    }

    const widget = {
        type: type,
        title: title
    };

    // –î–ª—è –º–µ—Ç—Ä–∏–∫–∏
    if (type === 'metric') {
        const coefficientId = document.getElementById('widgetCoefficient')?.value;
        if (!coefficientId) {
            alert('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç');
            return;
        }
        widget.coefficient_id = parseInt(coefficientId);
        widget.aggregation = document.getElementById('widgetAggregation')?.value || 'avg';
        widget.unit = document.getElementById('widgetUnit')?.value || '';
        widget.color = document.getElementById('widgetColor')?.value || 'primary';
    }

    // –î–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ (line, bar, horizontalBar)
    else if (['line', 'bar', 'horizontalBar'].includes(type)) {
        const coefficientId = document.getElementById('widgetCoefficient')?.value;
        if (!coefficientId) {
            alert('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç');
            return;
        }
        widget.coefficient_id = parseInt(coefficientId);
        widget.chart_type = type;
        widget.group_by = document.getElementById('widgetGroupBy')?.value || 'date';
        widget.color = document.getElementById('widgetColor')?.value || '#0d6efd';
    }

    // –î–ª—è –∫—Ä—É–≥–æ–≤—ã—Ö –¥–∏–∞–≥—Ä–∞–º–º (pie, doughnut, polarArea)
    else if (['pie', 'doughnut', 'polarArea'].includes(type)) {
        const coefficientId = document.getElementById('widgetCoefficient')?.value;
        if (!coefficientId) {
            alert('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç');
            return;
        }
        widget.coefficient_id = parseInt(coefficientId);
        widget.chart_type = type;
        widget.group_by = document.getElementById('widgetGroupBy')?.value || 'region';
        widget.max_segments = parseInt(document.getElementById('widgetMaxSegments')?.value) || 5;
    }

    // –î–ª—è —Ä–∞–¥–∞—Ä–∞
    else if (type === 'radar') {
        const selectedOptions = document.getElementById('widgetCoefficients')?.selectedOptions;
        if (!selectedOptions || selectedOptions.length < 3) {
            alert('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –º–∏–Ω–∏–º—É–º 3 –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è —Ä–∞–¥–∞—Ä–∞');
            return;
        }
        widget.chart_type = 'radar';
        widget.coefficient_ids = Array.from(selectedOptions).map(opt => parseInt(opt.value));
    }

    // –î–ª—è —Ç–∞–±–ª–∏—Ü—ã
    else if (type === 'table') {
        const coefficientId = document.getElementById('widgetCoefficient')?.value;
        if (!coefficientId) {
            alert('‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç');
            return;
        }
        widget.coefficient_id = parseInt(coefficientId);
        widget.group_by = document.getElementById('widgetGroupBy')?.value || 'outlet';
        widget.row_limit = parseInt(document.getElementById('widgetRowLimit')?.value) || 10;
        widget.sort = document.getElementById('widgetSort')?.value || 'desc';
    }

    widgets.push(widget);

    // –û–±–Ω–æ–≤–∏—Ç—å —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ
    const config = { widgets: widgets };
    document.getElementById('configInput').value = JSON.stringify(config);

    console.log('‚úÖ Widget saved:', widget);
    console.log('Total widgets:', widgets.length);

    // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    const modalElement = document.getElementById('widgetModal');
    const modal = bootstrap.Modal.getInstance(modalElement);
    modal.hide();

    alert(`‚úÖ –í–∏–¥–∂–µ—Ç "${title}" –¥–æ–±–∞–≤–ª–µ–Ω! –í—Å–µ–≥–æ –≤–∏–¥–∂–µ—Ç–æ–≤: ${widgets.length}\n\nüíæ –ù–∞–∂–º–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" –≤–Ω–∏–∑—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞—à–±–æ—Ä–¥.`);
};

console.log('Functions defined');
</script>

{% endblock %}

{% block extra_css %}
<style>
    .widget-card {
        border-left: 4px solid #0dcaf0;
        margin-bottom: 1rem;
        transition: all 0.3s;
    }
    .widget-card:hover {
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
    }
    .widget-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
console.log('=== SCRIPT BLOCK LOADED ===');

let widgets = [];
let editingIndex = null;
let allCoefficients = [];

// –í–ê–ñ–ù–û: –§—É–Ω–∫—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–±—ä—è–≤–ª–µ–Ω—ã –î–û DOMContentLoaded –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∏–∑ onclick

window.addWidget = function addWidget() {
    console.log('addWidget() called');
    editingIndex = null;
    document.getElementById('widgetType').value = '';
    document.getElementById('widgetFormContainer').innerHTML = '';
    const modalElement = document.getElementById('widgetModal');
    if (!modalElement) {
        console.error('Modal element not found');
        return;
    }
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
    console.log('Modal shown');
}

console.log('addWidget function defined:', typeof window.addWidget);

function updateWidgetForm() {
    console.log('updateWidgetForm() called');
    const type = document.getElementById('widgetType').value;
    const container = document.getElementById('widgetFormContainer');

    console.log('Widget type:', type);

    if (!type) {
        container.innerHTML = '';
        return;
    }

    if (type === 'metric') {
        container.innerHTML = `
            <div class="mb-3">
                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="widgetTitle" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞">
            </div>

            <div class="mb-3">
                <label class="form-label">–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç/–ú–µ—Ç—Ä–∏–∫–∞ <span class="text-danger">*</span></label>
                <select class="form-select" id="widgetCoefficient" onchange="updateCoefficientInfo()">
                    <option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>
                </select>
                <small class="form-text text-muted">
                    –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö (MON/EXP/AI) –±—É–¥–µ—Ç –≤—ã–±–∏—Ä–∞—Ç—å—Å—è –Ω–∞ —Å–∞–º–æ–º –¥–∞—à–±–æ—Ä–¥–µ –ø—Ä–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ
                </small>
                <div id="coefficientInfo" class="alert alert-info mt-2" style="display: none;"></div>
            </div>

            <div class="mb-3">
                <label class="form-label">–£—Ä–æ–≤–µ–Ω—å –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ <span class="text-danger">*</span></label>
                <select class="form-select" id="widgetAggregationLevel">
                    <option value="global">–ì–ª–æ–±–∞–ª—å–Ω—ã–π —Ä—ã–Ω–æ–∫</option>
                    <option value="country">–ü–æ —Å—Ç—Ä–∞–Ω–∞–º</option>
                    <option value="region">–ü–æ —Ä–µ–≥–∏–æ–Ω–∞–º</option>
                    <option value="channel">–ü–æ –∫–∞–Ω–∞–ª–∞–º —Å–±—ã—Ç–∞</option>
                    <option value="outlet">–ü–æ —Ç–æ—Ä–≥–æ–≤—ã–º —Ç–æ—á–∫–∞–º</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label">–§—É–Ω–∫—Ü–∏—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ <span class="text-danger">*</span></label>
                <select class="form-select" id="widgetAggregation">
                    <option value="avg">–°—Ä–µ–¥–Ω–µ–µ (AVG)</option>
                    <option value="sum">–°—É–º–º–∞ (SUM)</option>
                    <option value="count">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (COUNT)</option>
                    <option value="min">–ú–∏–Ω–∏–º—É–º (MIN)</option>
                    <option value="max">–ú–∞–∫—Å–∏–º—É–º (MAX)</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label">–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è</label>
                <input type="text" class="form-control" id="widgetUnit" placeholder="‚ÇΩ, %, —à—Ç">
            </div>

            <div class="mb-3">
                <label class="form-label">–¶–≤–µ—Ç <span class="text-danger">*</span></label>
                <select class="form-select" id="widgetColor">
                    <option value="primary">–°–∏–Ω–∏–π (Primary)</option>
                    <option value="success">–ó–µ–ª–µ–Ω—ã–π (Success)</option>
                    <option value="danger">–ö—Ä–∞—Å–Ω—ã–π (Danger)</option>
                    <option value="warning">–ñ–µ–ª—Ç—ã–π (Warning)</option>
                    <option value="info">–ì–æ–ª—É–±–æ–π (Info)</option>
                </select>
            </div>
        `;

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –°–†–ê–ó–£
        loadAllCoefficients();
    } else if (type === 'chart') {
        container.innerHTML = `
            <div class="mb-3">
                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="widgetTitle" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –¥–Ω—è–º">
            </div>

            <div class="mb-3">
                <label class="form-label">–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö <span class="text-danger">*</span></label>
                <select class="form-select" id="widgetDataSource" onchange="updateDataSourceFields()">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫...</option>
                    <option value="static">–°—Ç–∞—Ç–∏—á–Ω—ã–π (Coefficient)</option>
                    <option value="monitoring">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–≤—ã–π (Observation)</option>
                    <option value="expert">–≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–π (VisitMedia/Custom)</option>
                </select>
            </div>

            <div id="dataSourceFields"></div>

            <div class="mb-3">
                <label class="form-label">–¢–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞ <span class="text-danger">*</span></label>
                <select class="form-select" id="widgetChartType">
                    <option value="line">–õ–∏–Ω–µ–π–Ω—ã–π</option>
                    <option value="bar">–°—Ç–æ–ª–±—á–∞—Ç—ã–π</option>
                    <option value="pie">–ö—Ä—É–≥–æ–≤–æ–π</option>
                    <option value="doughnut">–ö–æ–ª—å—Ü–µ–≤–æ–π</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label">–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ <span class="text-danger">*</span></label>
                <select class="form-select" id="widgetGroupBy">
                    <option value="date">–ü–æ –¥–Ω—è–º</option>
                    <option value="week">–ü–æ –Ω–µ–¥–µ–ª—è–º</option>
                    <option value="month">–ü–æ –º–µ—Å—è—Ü–∞–º</option>
                    <option value="quarter">–ü–æ –∫–≤–∞—Ä—Ç–∞–ª–∞–º</option>
                    <option value="region">–ü–æ —Ä–µ–≥–∏–æ–Ω–∞–º</option>
                    <option value="country">–ü–æ —Å—Ç—Ä–∞–Ω–∞–º</option>
                    <option value="channel">–ü–æ –∫–∞–Ω–∞–ª–∞–º</option>
                    <option value="outlet">–ü–æ —Ç–æ—á–∫–∞–º</option>
                    <option value="brand">–ü–æ –±—Ä–µ–Ω–¥–∞–º</option>
                    <option value="category">–ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label">–¶–≤–µ—Ç –≥—Ä–∞—Ñ–∏–∫–∞</label>
                <input type="color" class="form-control" id="widgetColor" value="#4bc0c0">
            </div>
        `;
    }
}

// –•—Ä–∞–Ω–∏–ª–∏—â–µ –≤—Å–µ—Ö –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤
let allCoefficients = [];

// –ó–∞–≥—Ä—É–∑–∫–∞ –í–°–ï–• –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ (–±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ data_type)
function loadAllCoefficients() {
    const select = document.getElementById('widgetCoefficient');
    if (!select) {
        console.error('Select element not found');
        return;
    }

    console.log('Loading coefficients...');

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –í–°–ï –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã —Å —Å–µ—Ä–≤–µ—Ä–∞
    fetch('/api/coefficients/')
        .then(response => {
            console.log('Response status:', response.status);
            return response.json();
        })
        .then(coefficients => {
            console.log('Loaded coefficients:', coefficients.length);
            allCoefficients = coefficients;

            if (coefficients.length === 0) {
                select.innerHTML = '<option value="">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤</option>';
                return;
            }

            // –ó–∞–ø–æ–ª–Ω—è–µ–º select
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç...</option>' +
                coefficients.map(c => `
                    <option value="${c.id}"
                            data-unit="${c.unit || ''}"
                            data-type="${c.value_type}"
                            data-code="${c.code}"
                            data-data-type="${c.data_type}"
                            data-name="${c.name}">
                        ${c.name} ${c.unit ? '(' + c.unit + ')' : ''} [${c.data_type}]
                    </option>
                `).join('');

            console.log('Select populated successfully');
        })
        .catch(error => {
            console.error('Error loading coefficients:', error);
            select.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
        });
}

// –ü–æ–∫–∞–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–µ
function updateCoefficientInfo() {
    const select = document.getElementById('widgetCoefficient');
    const infoDiv = document.getElementById('coefficientInfo');

    if (!select || !infoDiv) return;

    const selectedOption = select.options[select.selectedIndex];
    if (selectedOption.value) {
        const unit = selectedOption.dataset.unit || '–±–µ–∑ –µ–¥–∏–Ω–∏—Ü';
        const type = selectedOption.dataset.type;
        const code = selectedOption.dataset.code;

        infoDiv.style.display = 'block';
        infoDiv.innerHTML = `
            <strong>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–µ:</strong><br>
            –ö–æ–¥: <code>${code}</code><br>
            –¢–∏–ø –∑–Ω–∞—á–µ–Ω–∏—è: ${type === 'numeric' ? '–ß–∏—Å–ª–æ–≤–æ–µ' : type === 'text' ? '–¢–µ–∫—Å—Ç–æ–≤–æ–µ' : '–î–∞/–ù–µ—Ç'}<br>
            –ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è: ${unit}
        `;
    } else {
        infoDiv.style.display = 'none';
    }
}

function saveWidget() {
    const type = document.getElementById('widgetType').value;
    const title = document.getElementById('widgetTitle')?.value;
    const coefficientId = document.getElementById('widgetCoefficient')?.value;

    if (!type || !title || !coefficientId) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: —Ç–∏–ø –≤–∏–¥–∂–µ—Ç–∞, –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç');
        return;
    }

    const widget = {
        type: type,
        title: title,
        coefficient_id: parseInt(coefficientId),
        aggregation_level: document.getElementById('widgetAggregationLevel')?.value || 'global',
        aggregation: document.getElementById('widgetAggregation')?.value || 'avg',
        unit: document.getElementById('widgetUnit')?.value || '',
        color: document.getElementById('widgetColor')?.value || 'primary'
    };

    if (type === 'chart') {
        widget.chart_type = document.getElementById('widgetChartType')?.value;
        widget.group_by = document.getElementById('widgetGroupBy')?.value;
        const color = document.getElementById('widgetColor')?.value || '#4bc0c0';
        widget.color = `rgba(${parseInt(color.slice(1,3), 16)}, ${parseInt(color.slice(3,5), 16)}, ${parseInt(color.slice(5,7), 16)}, 0.8)`;
    }

    if (editingIndex !== null) {
        widgets[editingIndex] = widget;
        editingIndex = null;
    } else {
        widgets.push(widget);
    }

    renderWidgets();
    updateConfigInput();
    bootstrap.Modal.getInstance(document.getElementById('widgetModal')).hide();
}

function renderWidgets() {
    const container = document.getElementById('widgetsContainer');
    const emptyState = document.getElementById('emptyState');

    if (widgets.length === 0) {
        container.innerHTML = '';
        emptyState.style.display = 'block';
        return;
    }

    emptyState.style.display = 'none';

    container.innerHTML = widgets.map((widget, index) => {
        const typeIcon = widget.type === 'metric' ? 'üìä' : 'üìà';
        const typeName = widget.type === 'metric' ? '–ú–µ—Ç—Ä–∏–∫–∞' : '–ì—Ä–∞—Ñ–∏–∫';

        // –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö
        const dataTypeLabels = {
            'MON': '–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–≤—ã–µ',
            'EXP': '–≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–µ',
            'AI': '–î–∞–Ω–Ω—ã–µ –ò–ò'
        };
        const dataTypeLabel = dataTypeLabels[widget.data_type] || widget.data_type;
        const dataTypeBadge = widget.data_type === 'MON' ? 'bg-primary' : widget.data_type === 'EXP' ? 'bg-success' : 'bg-info';

        // –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å –∞–≥—Ä–µ–≥–∞—Ü–∏–∏
        const aggLevelLabels = {
            'global': '–ì–ª–æ–±–∞–ª—å–Ω—ã–π —Ä—ã–Ω–æ–∫',
            'country': '–ü–æ —Å—Ç—Ä–∞–Ω–∞–º',
            'region': '–ü–æ —Ä–µ–≥–∏–æ–Ω–∞–º',
            'channel': '–ü–æ –∫–∞–Ω–∞–ª–∞–º',
            'outlet': '–ü–æ —Ç–æ—á–∫–∞–º'
        };
        const aggLevelLabel = aggLevelLabels[widget.aggregation_level] || widget.aggregation_level;

        // –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–µ
        const coef = filteredCoefficients.find(c => c.id === widget.coefficient_id) || {name: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', code: 'unknown'};

        return `
            <div class="card widget-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">
                                ${typeIcon} ${widget.title}
                                <span class="badge widget-badge bg-secondary">${typeName}</span>
                                <span class="badge ${dataTypeBadge}">${dataTypeLabel}</span>
                            </h6>
                            <small class="text-muted">
                                –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç: <strong>${coef.name}</strong> ${coef.unit ? '(' + coef.unit + ')' : ''}<br>
                                –ö–æ–¥: <code>${coef.code}</code><br>
                                –£—Ä–æ–≤–µ–Ω—å: <strong>${aggLevelLabel}</strong><br>
                                –ê–≥—Ä–µ–≥–∞—Ü–∏—è: <strong>${widget.aggregation?.toUpperCase() || 'AVG'}</strong>
                            </small>
                            ${widget.type === 'metric' ? `
                                <br><small class="text-muted">–ï–¥–∏–Ω–∏—Ü–∞: <strong>${widget.unit || coef.unit || '-'}</strong></small>
                            ` : `
                                <br><small class="text-muted">
                                    –ì—Ä–∞—Ñ–∏–∫: <strong>${widget.chart_type === 'line' ? '–õ–∏–Ω–µ–π–Ω—ã–π' : '–°—Ç–æ–ª–±—á–∞—Ç—ã–π'}</strong>,
                                    –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞: <strong>${getGroupByName(widget.group_by)}</strong>
                                </small>
                            `}
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteWidget(${index})" title="–£–¥–∞–ª–∏—Ç—å">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    updateConfigInput();
}

function getGroupByName(value) {
    const names = {
        'date': '–ø–æ –¥–Ω—è–º',
        'week': '–ø–æ –Ω–µ–¥–µ–ª—è–º',
        'month': '–ø–æ –º–µ—Å—è—Ü–∞–º',
        'region': '–ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º',
        'channel': '–ø–æ –∫–∞–Ω–∞–ª–∞–º',
        'outlet': '–ø–æ —Ç–æ—á–∫–∞–º'
    };
    return names[value] || value;
}

function deleteWidget(index) {
    if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –≤–∏–¥–∂–µ—Ç?')) {
        widgets.splice(index, 1);
        renderWidgets();
    }
}

function updateConfigInput() {
    const config = {
        widgets: widgets
    };
    document.getElementById('configInput').value = JSON.stringify(config);
}

// –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ submit –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
function attachSubmitHandler() {
    const dashboardForm = document.getElementById('dashboardForm');
    console.log('Attaching submit handler, form:', dashboardForm);

    if (dashboardForm) {
        dashboardForm.addEventListener('submit', function(e) {
            console.log('=== FORM SUBMIT EVENT TRIGGERED ===');
            updateConfigInput();

            // Debug: –ø–æ–∫–∞–∑–∞—Ç—å —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è
            const formData = new FormData(this);
            console.log('=== –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã –¥–∞—à–±–æ—Ä–¥–∞ ===');
            for (let [key, value] of formData.entries()) {
                console.log(`${key}:`, value);
            }
            console.log('=== –ö–æ–Ω–µ—Ü –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã ===');
        });
        console.log('‚úÖ Submit handler attached to dashboard form');
    } else {
        console.error('‚ùå Dashboard form not found!');
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Dashboard form JavaScript loaded');

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è Bootstrap
    if (typeof bootstrap === 'undefined') {
        console.error('Bootstrap is not loaded!');
    } else {
        console.log('Bootstrap is available');
    }

    // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –≤–∏–¥–∂–µ—Ç—ã –µ—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º
    {% if object and object.widgets_config %}
    try {
        const config = {{ object.widgets_config|safe }};
        if (config && config.widgets) {
            widgets = config.widgets;
            renderWidgets();
        }
    } catch(e) {
        console.error('Error loading widgets_config:', e);
    }
    {% endif %}

    // –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    attachSubmitHandler();
});
</script>
{% endblock %}
