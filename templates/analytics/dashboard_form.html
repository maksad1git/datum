{% extends 'base.html' %}

{% block title %}{% if object %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å {{ object.name }}{% else %}–°–æ–∑–¥–∞—Ç—å –¥–∞—à–±–æ—Ä–¥{% endif %} - Datum{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1 class="h2">
            <i class="bi bi-graph-up"></i>
            {% if object %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å: {{ object.name }}{% else %}–°–æ–∑–¥–∞—Ç—å –¥–∞—à–±–æ—Ä–¥{% endif %}
        </h1>
    </div>
</div>

<form method="post" id="dashboardForm">
    {% csrf_token %}

    <div class="row">
        <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å: –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
                </div>
                <div class="card-body">
                    {% if form.non_field_errors %}
                    <div class="alert alert-danger">{{ form.non_field_errors }}</div>
                    {% endif %}

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">{{ form.name.label }} <span class="text-danger">*</span></label>
                            {{ form.name }}
                            {% if form.name.errors %}
                            <div class="invalid-feedback d-block">{{ form.name.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">{{ form.code.label }} <span class="text-danger">*</span></label>
                            {{ form.code }}
                            {% if form.code.errors %}
                            <div class="invalid-feedback d-block">{{ form.code.errors }}</div>
                            {% endif %}
                            <small class="form-text text-muted">–õ–∞—Ç–∏–Ω–∏—Ü–µ–π, –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤</small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">{{ form.description.label }}</label>
                        {{ form.description }}
                        {% if form.description.errors %}
                        <div class="invalid-feedback d-block">{{ form.description.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label class="form-label">{{ form.dashboard_type.label }} <span class="text-danger">*</span></label>
                        {{ form.dashboard_type }}
                        {% if form.dashboard_type.errors %}
                        <div class="invalid-feedback d-block">{{ form.dashboard_type.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –¥–∞—à–±–æ—Ä–¥–∞</small>
                    </div>

                    <div class="form-check">
                        {{ form.is_active }}
                        <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                            {{ form.is_active.label }}
                        </label>
                    </div>
                </div>
            </div>

            <!-- –í–∏–∑—É–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –≤–∏–¥–∂–µ—Ç–æ–≤ -->
            <div class="card">
                <div class="card-header bg-info text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-grid-3x3"></i> –í–∏–¥–∂–µ—Ç—ã –¥–∞—à–±–æ—Ä–¥–∞</h5>
                        <button type="button" class="btn btn-light btn-sm" onclick="addWidget()">
                            <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –≤–∏–¥–∂–µ—Ç
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="widgetsContainer">
                        <!-- –í–∏–¥–∂–µ—Ç—ã –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —Å—é–¥–∞ -->
                    </div>

                    <div id="emptyState" class="text-center py-5 text-muted">
                        <i class="bi bi-graph-up" style="font-size: 4rem;"></i>
                        <p class="mt-3">–ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å –≤–∏–¥–∂–µ—Ç" —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</p>
                    </div>
                </div>
            </div>

            <!-- –î–æ—Å—Ç—É–ø –∫ –¥–∞—à–±–æ—Ä–¥—É -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-shield-lock"></i> –î–æ—Å—Ç—É–ø</h5>
                </div>
                <div class="card-body">
                    <div class="form-check mb-3">
                        {{ form.is_public }}
                        <label class="form-check-label" for="{{ form.is_public.id_for_label }}">
                            {{ form.is_public.label }}
                        </label>
                        <small class="form-text text-muted d-block">–ü—É–±–ª–∏—á–Ω—ã–π –¥–∞—à–±–æ—Ä–¥ –¥–æ—Å—Ç—É–ø–µ–Ω –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">{{ form.shared_with.label }}</label>
                        {{ form.shared_with }}
                        {% if form.shared_with.errors %}
                        <div class="invalid-feedback d-block">{{ form.shared_with.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —Å –∫–æ—Ç–æ—Ä—ã–º–∏ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –¥–∞—à–±–æ—Ä–¥–æ–º</small>
                    </div>
                </div>
            </div>

            <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è widgets_config -->
            <input type="hidden" name="widgets_config" id="configInput" value='{"widgets":[]}'>

            <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ -->
            <input type="hidden" name="default_filters" value="{}">
            <input type="hidden" name="refresh_interval" value="15">
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å: –î–µ–π—Å—Ç–≤–∏—è –∏ –ø—Ä–µ–≤—å—é -->
        <div class="col-lg-4">
            <div class="card sticky-top" style="top: 20px;">
                <div class="card-header bg-light">
                    <h5 class="mb-0">–î–µ–π—Å—Ç–≤–∏—è</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="bi bi-check-circle"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                        </button>
                        <a href="{% if object %}{% url 'analytics:dashboard_detail' object.pk %}{% else %}{% url 'analytics:dashboard_list' %}{% endif %}"
                           class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> –û—Ç–º–µ–Ω–∞
                        </a>
                    </div>
                </div>

                <div class="card-footer">
                    <small class="text-muted">
                        <strong>–¢–∏–ø—ã –≤–∏–¥–∂–µ—Ç–æ–≤:</strong><br>
                        ‚Ä¢ –ú–µ—Ç—Ä–∏–∫–∞ - –æ–¥–Ω–æ —á–∏—Å–ª–æ<br>
                        ‚Ä¢ –ì—Ä–∞—Ñ–∏–∫ - –ª–∏–Ω–µ–π–Ω—ã–π/—Å—Ç–æ–ª–±—á–∞—Ç—ã–π
                    </small>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤–∏–¥–∂–µ—Ç–∞ -->
<div class="modal fade" id="widgetModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –≤–∏–¥–∂–µ—Ç</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">–¢–∏–ø –≤–∏–¥–∂–µ—Ç–∞ <span class="text-danger">*</span></label>
                    <select class="form-select" id="widgetType" onchange="updateWidgetForm()">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø...</option>
                        <option value="metric">üìä –ú–µ—Ç—Ä–∏–∫–∞ (–æ–¥–Ω–æ —á–∏—Å–ª–æ)</option>
                        <option value="chart">üìà –ì—Ä–∞—Ñ–∏–∫</option>
                    </select>
                </div>

                <div id="widgetFormContainer"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" onclick="saveWidget()">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .widget-card {
        border-left: 4px solid #0dcaf0;
        margin-bottom: 1rem;
        transition: all 0.3s;
    }
    .widget-card:hover {
        box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
    }
    .widget-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
let widgets = [];
let editingIndex = null;
let allCoefficients = [];

// –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Dashboard form JavaScript loaded');

    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã —á–µ—Ä–µ–∑ AJAX
    fetch('/api/coefficients/')
        .then(response => response.json())
        .then(data => {
            allCoefficients = data;
        })
        .catch(() => {
            // Fallback: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–∞–≥–ª—É—à–∫–∏
            allCoefficients = [
                {id: 1, name: '–¶–µ–Ω–∞', code: 'price', unit: '‚ÇΩ'},
                {id: 2, name: '–ù–∞–ª–∏—á–∏–µ', code: 'availability', unit: '%'},
                {id: 3, name: '–ü—Ä–æ–º–æ', code: 'promo', unit: '—à—Ç'}
            ];
        });

    // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –≤–∏–¥–∂–µ—Ç—ã –µ—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º
    {% if object and object.widgets_config %}
    try {
        const config = {{ object.widgets_config|safe }};
        if (config && config.widgets) {
            widgets = config.widgets;
            renderWidgets();
        }
    } catch(e) {
        console.error('Error loading widgets_config:', e);
    }
    {% endif %}

    // –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    attachSubmitHandler();
});

function addWidget() {
    editingIndex = null;
    document.getElementById('widgetType').value = '';
    document.getElementById('widgetFormContainer').innerHTML = '';
    const modal = new bootstrap.Modal(document.getElementById('widgetModal'));
    modal.show();
}

function updateWidgetForm() {
    const type = document.getElementById('widgetType').value;
    const container = document.getElementById('widgetFormContainer');

    if (!type) {
        container.innerHTML = '';
        return;
    }

    if (type === 'metric') {
        container.innerHTML = `
            <div class="mb-3">
                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="widgetTitle" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞">
            </div>

            <div class="mb-3">
                <label class="form-label">–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö <span class="text-danger">*</span></label>
                <select class="form-select" id="widgetDataSource" onchange="updateDataSourceFields()">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫...</option>
                    <option value="static">–°—Ç–∞—Ç–∏—á–Ω—ã–π (Coefficient)</option>
                    <option value="monitoring">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–≤—ã–π (Observation)</option>
                    <option value="expert">–≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–π (VisitMedia/Custom)</option>
                </select>
                <small class="form-text text-muted">
                    ‚Ä¢ –°—Ç–∞—Ç–∏—á–Ω—ã–π - —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤<br>
                    ‚Ä¢ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–≤—ã–π - –¥–∞–Ω–Ω—ã–µ –∏–∑ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π –≤ –≤–∏–∑–∏—Ç–∞—Ö<br>
                    ‚Ä¢ –≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–π - –¥–∞–Ω–Ω—ã–µ, –≤–Ω–µ—Å–µ–Ω–Ω—ã–µ —ç–∫—Å–ø–µ—Ä—Ç–∞–º–∏
                </small>
            </div>

            <div id="dataSourceFields"></div>

            <div class="mb-3">
                <label class="form-label">–£—Ä–æ–≤–µ–Ω—å –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ <span class="text-danger">*</span></label>
                <select class="form-select" id="widgetAggregationLevel">
                    <option value="global">–ì–ª–æ–±–∞–ª—å–Ω—ã–π —Ä—ã–Ω–æ–∫</option>
                    <option value="country">–ü–æ —Å—Ç—Ä–∞–Ω–∞–º</option>
                    <option value="region">–ü–æ —Ä–µ–≥–∏–æ–Ω–∞–º</option>
                    <option value="channel">–ü–æ –∫–∞–Ω–∞–ª–∞–º —Å–±—ã—Ç–∞</option>
                    <option value="outlet">–ü–æ —Ç–æ—Ä–≥–æ–≤—ã–º —Ç–æ—á–∫–∞–º</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label">–§—É–Ω–∫—Ü–∏—è –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ <span class="text-danger">*</span></label>
                <select class="form-select" id="widgetAggregation">
                    <option value="avg">–°—Ä–µ–¥–Ω–µ–µ (AVG)</option>
                    <option value="sum">–°—É–º–º–∞ (SUM)</option>
                    <option value="count">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (COUNT)</option>
                    <option value="min">–ú–∏–Ω–∏–º—É–º (MIN)</option>
                    <option value="max">–ú–∞–∫—Å–∏–º—É–º (MAX)</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label">–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è</label>
                <input type="text" class="form-control" id="widgetUnit" placeholder="‚ÇΩ, %, —à—Ç">
            </div>

            <div class="mb-3">
                <label class="form-label">–¶–≤–µ—Ç <span class="text-danger">*</span></label>
                <select class="form-select" id="widgetColor">
                    <option value="primary">–°–∏–Ω–∏–π (Primary)</option>
                    <option value="success">–ó–µ–ª–µ–Ω—ã–π (Success)</option>
                    <option value="danger">–ö—Ä–∞—Å–Ω—ã–π (Danger)</option>
                    <option value="warning">–ñ–µ–ª—Ç—ã–π (Warning)</option>
                    <option value="info">–ì–æ–ª—É–±–æ–π (Info)</option>
                </select>
            </div>
        `;
    } else if (type === 'chart') {
        container.innerHTML = `
            <div class="mb-3">
                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="widgetTitle" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –¥–Ω—è–º">
            </div>

            <div class="mb-3">
                <label class="form-label">–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö <span class="text-danger">*</span></label>
                <select class="form-select" id="widgetDataSource" onchange="updateDataSourceFields()">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ç–æ—á–Ω–∏–∫...</option>
                    <option value="static">–°—Ç–∞—Ç–∏—á–Ω—ã–π (Coefficient)</option>
                    <option value="monitoring">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–≤—ã–π (Observation)</option>
                    <option value="expert">–≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–π (VisitMedia/Custom)</option>
                </select>
            </div>

            <div id="dataSourceFields"></div>

            <div class="mb-3">
                <label class="form-label">–¢–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞ <span class="text-danger">*</span></label>
                <select class="form-select" id="widgetChartType">
                    <option value="line">–õ–∏–Ω–µ–π–Ω—ã–π</option>
                    <option value="bar">–°—Ç–æ–ª–±—á–∞—Ç—ã–π</option>
                    <option value="pie">–ö—Ä—É–≥–æ–≤–æ–π</option>
                    <option value="doughnut">–ö–æ–ª—å—Ü–µ–≤–æ–π</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label">–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ <span class="text-danger">*</span></label>
                <select class="form-select" id="widgetGroupBy">
                    <option value="date">–ü–æ –¥–Ω—è–º</option>
                    <option value="week">–ü–æ –Ω–µ–¥–µ–ª—è–º</option>
                    <option value="month">–ü–æ –º–µ—Å—è—Ü–∞–º</option>
                    <option value="quarter">–ü–æ –∫–≤–∞—Ä—Ç–∞–ª–∞–º</option>
                    <option value="region">–ü–æ —Ä–µ–≥–∏–æ–Ω–∞–º</option>
                    <option value="country">–ü–æ —Å—Ç—Ä–∞–Ω–∞–º</option>
                    <option value="channel">–ü–æ –∫–∞–Ω–∞–ª–∞–º</option>
                    <option value="outlet">–ü–æ —Ç–æ—á–∫–∞–º</option>
                    <option value="brand">–ü–æ –±—Ä–µ–Ω–¥–∞–º</option>
                    <option value="category">–ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label">–¶–≤–µ—Ç –≥—Ä–∞—Ñ–∏–∫–∞</label>
                <input type="color" class="form-control" id="widgetColor" value="#4bc0c0">
            </div>
        `;
    }
}

function updateDataSourceFields() {
    const dataSource = document.getElementById('widgetDataSource')?.value;
    const container = document.getElementById('dataSourceFields');

    if (!container) return;

    if (dataSource === 'static') {
        // –°—Ç–∞—Ç–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ - –≤—ã–±–æ—Ä –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞
        container.innerHTML = `
            <div class="mb-3">
                <label class="form-label">–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç <span class="text-danger">*</span></label>
                <select class="form-select" id="widgetCoefficient">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç...</option>
                    ${allCoefficients.map(c => `<option value="${c.id}" data-unit="${c.unit || ''}">${c.name} (${c.code})</option>`).join('')}
                </select>
                <small class="form-text text-muted">–ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ —Å—Ç–∞—Ç–∏—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞</small>
            </div>
        `;
    } else if (dataSource === 'monitoring') {
        // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ - –∏–∑ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π
        container.innerHTML = `
            <div class="mb-3">
                <label class="form-label">–ú–µ—Ç—Ä–∏–∫–∞ <span class="text-danger">*</span></label>
                <select class="form-select" id="widgetMetric">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Ç—Ä–∏–∫—É...</option>
                    <option value="osa">–ù–∞–ª–∏—á–∏–µ —Ç–æ–≤–∞—Ä–∞ (OSA)</option>
                    <option value="price">–¶–µ–Ω–∞</option>
                    <option value="promo">–ü—Ä–æ–º–æ-–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</option>
                    <option value="shelf_share">–î–æ–ª—è –ø–æ–ª–∫–∏</option>
                    <option value="facing_count">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–µ–π—Å–∏–Ω–≥–æ–≤</option>
                </select>
                <small class="form-text text-muted">–î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —Å–æ–±—Ä–∞–Ω—ã –∏–∑ –Ω–∞–±–ª—é–¥–µ–Ω–∏–π –≤ –≤–∏–∑–∏—Ç–∞—Ö</small>
            </div>

            <div class="mb-3">
                <label class="form-label">–§–∏–ª—å—Ç—Ä –ø–æ –±—Ä–µ–Ω–¥–∞–º</label>
                <input type="text" class="form-control" id="widgetBrandFilter" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –≤—Å–µ—Ö –±—Ä–µ–Ω–¥–æ–≤">
                <small class="form-text text-muted">ID –±—Ä–µ–Ω–¥–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é, –Ω–∞–ø—Ä–∏–º–µ—Ä: 1,2,3</small>
            </div>

            <div class="mb-3">
                <label class="form-label">–§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</label>
                <input type="text" class="form-control" id="widgetCategoryFilter" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π">
                <small class="form-text text-muted">ID –∫–∞—Ç–µ–≥–æ—Ä–∏–π —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é</small>
            </div>
        `;
    } else if (dataSource === 'expert') {
        // –≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        container.innerHTML = `
            <div class="mb-3">
                <label class="form-label">–¢–∏–ø —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö <span class="text-danger">*</span></label>
                <select class="form-select" id="widgetExpertType">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø...</option>
                    <option value="visit_quality">–ö–∞—á–µ—Å—Ç–≤–æ –≤–∏–∑–∏—Ç–∞</option>
                    <option value="outlet_rating">–†–µ–π—Ç–∏–Ω–≥ —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏</option>
                    <option value="compliance">–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º</option>
                    <option value="custom">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –º–µ—Ç—Ä–∏–∫–∞</option>
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label">–§–æ—Ä–º—É–ª–∞ —Ä–∞—Å—á–µ—Ç–∞</label>
                <textarea class="form-control" id="widgetFormula" rows="3" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: (score1 + score2) / 2"></textarea>
                <small class="form-text text-muted">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ –ø–æ–¥—Å—á–µ—Ç–∞</small>
            </div>
        `;
    } else {
        container.innerHTML = '';
    }
}

function saveWidget() {
    const type = document.getElementById('widgetType').value;
    const title = document.getElementById('widgetTitle')?.value;
    const dataSource = document.getElementById('widgetDataSource')?.value;

    if (!type || !title || !dataSource) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
        return;
    }

    const widget = {
        type: type,
        title: title,
        data_source: dataSource,
        aggregation_level: document.getElementById('widgetAggregationLevel')?.value || 'global',
        aggregation: document.getElementById('widgetAggregation')?.value || 'avg',
        unit: document.getElementById('widgetUnit')?.value || '',
        color: document.getElementById('widgetColor')?.value || 'primary'
    };

    // –î–æ–±–∞–≤–∏—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –ø–æ–ª—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∞
    if (dataSource === 'static') {
        widget.coefficient_id = parseInt(document.getElementById('widgetCoefficient')?.value);
    } else if (dataSource === 'monitoring') {
        widget.metric = document.getElementById('widgetMetric')?.value;
        widget.brand_filter = document.getElementById('widgetBrandFilter')?.value;
        widget.category_filter = document.getElementById('widgetCategoryFilter')?.value;
    } else if (dataSource === 'expert') {
        widget.expert_type = document.getElementById('widgetExpertType')?.value;
        widget.formula = document.getElementById('widgetFormula')?.value;
    }

    if (type === 'chart') {
        widget.chart_type = document.getElementById('widgetChartType')?.value;
        widget.group_by = document.getElementById('widgetGroupBy')?.value;
        const color = document.getElementById('widgetColor')?.value || '#4bc0c0';
        widget.color = `rgba(${parseInt(color.slice(1,3), 16)}, ${parseInt(color.slice(3,5), 16)}, ${parseInt(color.slice(5,7), 16)}, 0.8)`;
    }

    if (editingIndex !== null) {
        widgets[editingIndex] = widget;
        editingIndex = null;
    } else {
        widgets.push(widget);
    }

    renderWidgets();
    bootstrap.Modal.getInstance(document.getElementById('widgetModal')).hide();
}

function renderWidgets() {
    const container = document.getElementById('widgetsContainer');
    const emptyState = document.getElementById('emptyState');

    if (widgets.length === 0) {
        container.innerHTML = '';
        emptyState.style.display = 'block';
        return;
    }

    emptyState.style.display = 'none';

    container.innerHTML = widgets.map((widget, index) => {
        const typeIcon = widget.type === 'metric' ? 'üìä' : 'üìà';
        const typeName = widget.type === 'metric' ? '–ú–µ—Ç—Ä–∏–∫–∞' : '–ì—Ä–∞—Ñ–∏–∫';

        // –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö
        const dataSourceLabels = {
            'static': '–°—Ç–∞—Ç–∏—á–Ω—ã–π',
            'monitoring': '–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–≤—ã–π',
            'expert': '–≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–π'
        };
        const dataSourceLabel = dataSourceLabels[widget.data_source] || widget.data_source;

        // –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å –∞–≥—Ä–µ–≥–∞—Ü–∏–∏
        const aggLevelLabels = {
            'global': '–ì–ª–æ–±–∞–ª—å–Ω—ã–π —Ä—ã–Ω–æ–∫',
            'country': '–ü–æ —Å—Ç—Ä–∞–Ω–∞–º',
            'region': '–ü–æ —Ä–µ–≥–∏–æ–Ω–∞–º',
            'channel': '–ü–æ –∫–∞–Ω–∞–ª–∞–º',
            'outlet': '–ü–æ —Ç–æ—á–∫–∞–º'
        };
        const aggLevelLabel = aggLevelLabels[widget.aggregation_level] || widget.aggregation_level;

        // –ü–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∞
        let detailsHtml = '';
        if (widget.data_source === 'static') {
            const coef = allCoefficients.find(c => c.id === widget.coefficient_id) || {name: 'Unknown', code: 'unknown'};
            detailsHtml = `<strong>${coef.name}</strong> (${coef.code})`;
        } else if (widget.data_source === 'monitoring') {
            detailsHtml = `–ú–µ—Ç—Ä–∏–∫–∞: <strong>${widget.metric || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}</strong>`;
        } else if (widget.data_source === 'expert') {
            detailsHtml = `–¢–∏–ø: <strong>${widget.expert_type || '–Ω–µ —É–∫–∞–∑–∞–Ω'}</strong>`;
        }

        return `
            <div class="card widget-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">
                                ${typeIcon} ${widget.title}
                                <span class="badge widget-badge bg-secondary">${typeName}</span>
                            </h6>
                            <small class="text-muted">
                                –ò—Å—Ç–æ—á–Ω–∏–∫: <strong>${dataSourceLabel}</strong><br>
                                ${detailsHtml}<br>
                                –£—Ä–æ–≤–µ–Ω—å: <strong>${aggLevelLabel}</strong><br>
                                –ê–≥—Ä–µ–≥–∞—Ü–∏—è: <strong>${widget.aggregation?.toUpperCase() || 'AVG'}</strong>
                            </small>
                            ${widget.type === 'metric' ? `
                                <br><small class="text-muted">–ï–¥–∏–Ω–∏—Ü–∞: <strong>${widget.unit || '-'}</strong></small>
                            ` : `
                                <br><small class="text-muted">
                                    –ì—Ä–∞—Ñ–∏–∫: <strong>${widget.chart_type === 'line' ? '–õ–∏–Ω–µ–π–Ω—ã–π' : '–°—Ç–æ–ª–±—á–∞—Ç—ã–π'}</strong>,
                                    –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞: <strong>${getGroupByName(widget.group_by)}</strong>
                                </small>
                            `}
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteWidget(${index})" title="–£–¥–∞–ª–∏—Ç—å">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    updateConfigInput();
}

function getGroupByName(value) {
    const names = {
        'date': '–ø–æ –¥–Ω—è–º',
        'week': '–ø–æ –Ω–µ–¥–µ–ª—è–º',
        'month': '–ø–æ –º–µ—Å—è—Ü–∞–º',
        'region': '–ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º',
        'channel': '–ø–æ –∫–∞–Ω–∞–ª–∞–º',
        'outlet': '–ø–æ —Ç–æ—á–∫–∞–º'
    };
    return names[value] || value;
}

function deleteWidget(index) {
    if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –≤–∏–¥–∂–µ—Ç?')) {
        widgets.splice(index, 1);
        renderWidgets();
    }
}

function updateConfigInput() {
    const config = {
        widgets: widgets
    };
    document.getElementById('configInput').value = JSON.stringify(config);
}

// –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ submit –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
function attachSubmitHandler() {
    const dashboardForm = document.getElementById('dashboardForm');
    console.log('Attaching submit handler, form:', dashboardForm);

    if (dashboardForm) {
        dashboardForm.addEventListener('submit', function(e) {
            console.log('=== FORM SUBMIT EVENT TRIGGERED ===');
            updateConfigInput();

            // Debug: –ø–æ–∫–∞–∑–∞—Ç—å —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è
            const formData = new FormData(this);
            console.log('=== –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã –¥–∞—à–±–æ—Ä–¥–∞ ===');
            for (let [key, value] of formData.entries()) {
                console.log(`${key}:`, value);
            }
            console.log('=== –ö–æ–Ω–µ—Ü –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã ===');
        });
        console.log('‚úÖ Submit handler attached to dashboard form');
    } else {
        console.error('‚ùå Dashboard form not found!');
    }
}
</script>
{% endblock %}
