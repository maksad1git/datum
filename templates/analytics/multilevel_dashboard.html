{% extends 'base.html' %}

{% block title %}–ú—É–ª—å—Ç–∏—É—Ä–æ–≤–Ω–µ–≤–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ - Datum{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1 class="h2">
            <i class="bi bi-graph-up"></i> –ú—É–ª—å—Ç–∏—É—Ä–æ–≤–Ω–µ–≤–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
            <span id="lastUpdated" class="small text-muted"></span>
        </h1>
        <p class="text-muted">–ü–µ—Ä–µ–∫–ª—é—á–∞–π—Ç–µ—Å—å –º–µ–∂–¥—É —É—Ä–æ–≤–Ω—è–º–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö</p>
    </div>
    <div class="col-auto">
        <div class="btn-group">
            <button class="btn btn-outline-secondary btn-sm" onclick="toggleAutoRefresh()" id="autoRefreshBtn">
                <i id="autoRefreshIcon" class="bi bi-pause-circle"></i>
                <span id="autoRefreshText">–ê–≤—Ç–æ</span>
            </button>
            <button class="btn btn-primary btn-sm" onclick="refreshDashboard()">
                <i class="bi bi-arrow-clockwise"></i> –û–±–Ω–æ–≤–∏—Ç—å
            </button>
        </div>
    </div>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã —Å –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–µ–º —É—Ä–æ–≤–Ω–µ–π –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ -->
<div class="card mb-4" id="filterCard">
    <div class="card-body">
        <form method="get" id="filterForm">
            <div class="row g-2 align-items-end">
                <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —É—Ä–æ–≤–Ω–µ–π (–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ –ë–î) -->
                <div class="col-auto">
                    <label class="form-label small mb-1">–£—Ä–æ–≤–µ–Ω—å</label>
                    <div class="btn-group" role="group">
                        {% for dashboard in level_dashboards %}
                        <button type="button" onclick="changeLevel('{{ dashboard.level }}')"
                                class="btn btn-sm {% if level == dashboard.level %}btn-primary{% else %}btn-outline-primary{% endif %}"
                                title="{{ dashboard.description }}">
                            {{ dashboard.level_icon }} {{ dashboard.get_level_display }}
                        </button>
                        {% empty %}
                        <span class="text-muted">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π</span>
                        {% endfor %}
                    </div>
                    <input type="hidden" name="level" value="{{ level }}" id="levelInput">
                </div>

                <!-- –°–µ–ª–µ–∫—Ç–æ—Ä —Å—É—â–Ω–æ—Å—Ç–∏ -->
                <div class="col-auto" style="min-width: 200px;">
                    {% if level == 'country' %}
                        <label class="form-label small mb-1">üåç –°—Ç—Ä–∞–Ω–∞</label>
                        <select name="entity_id" class="form-select form-select-sm">
                            <option value="">–í—Å–µ —Å—Ç—Ä–∞–Ω—ã</option>
                            {% for country in countries %}
                            <option value="{{ country.id }}" {% if filters.country|stringformat:"s" == country.id|stringformat:"s" %}selected{% endif %}>
                                {{ country.name }}
                            </option>
                            {% endfor %}
                        </select>
                    {% elif level == 'region' %}
                        <label class="form-label small mb-1">üåê –†–µ–≥–∏–æ–Ω</label>
                        <select name="entity_id" class="form-select form-select-sm">
                            <option value="">–í—Å–µ —Ä–µ–≥–∏–æ–Ω—ã</option>
                            {% for region in regions %}
                            <option value="{{ region.id }}" {% if filters.region|stringformat:"s" == region.id|stringformat:"s" %}selected{% endif %}>
                                {{ region.name }}
                            </option>
                            {% endfor %}
                        </select>
                    {% elif level == 'city' %}
                        <label class="form-label small mb-1">üèôÔ∏è –ì–æ—Ä–æ–¥</label>
                        <select name="entity_id" class="form-select form-select-sm">
                            <option value="">–í—Å–µ –≥–æ—Ä–æ–¥–∞</option>
                            {% for city in cities %}
                            <option value="{{ city.id }}" {% if filters.city|stringformat:"s" == city.id|stringformat:"s" %}selected{% endif %}>
                                {{ city.name }}
                            </option>
                            {% endfor %}
                        </select>
                    {% elif level == 'district' %}
                        <label class="form-label small mb-1">üèòÔ∏è –†–∞–π–æ–Ω</label>
                        <select name="entity_id" class="form-select form-select-sm">
                            <option value="">–í—Å–µ —Ä–∞–π–æ–Ω—ã</option>
                            {% for district in districts %}
                            <option value="{{ district.id }}" {% if filters.district|stringformat:"s" == district.id|stringformat:"s" %}selected{% endif %}>
                                {{ district.name }}
                            </option>
                            {% endfor %}
                        </select>
                    {% elif level == 'channel' %}
                        <label class="form-label small mb-1">üì¢ –ö–∞–Ω–∞–ª —Å–±—ã—Ç–∞</label>
                        <select name="entity_id" class="form-select form-select-sm">
                            <option value="">–í—Å–µ –∫–∞–Ω–∞–ª—ã</option>
                            {% for channel in channels %}
                            <option value="{{ channel.id }}" {% if filters.channel|stringformat:"s" == channel.id|stringformat:"s" %}selected{% endif %}>
                                {{ channel.name }}
                            </option>
                            {% endfor %}
                        </select>
                    {% elif level == 'outlet' %}
                        <label class="form-label small mb-1">üè™ –¢–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞</label>
                        <select name="entity_id" class="form-select form-select-sm">
                            <option value="">–í—Å–µ —Ç–æ—á–∫–∏</option>
                            {% for outlet in outlets %}
                            <option value="{{ outlet.id }}" {% if filters.outlet|stringformat:"s" == outlet.id|stringformat:"s" %}selected{% endif %}>
                                {{ outlet.name }}
                            </option>
                            {% endfor %}
                        </select>
                    {% endif %}
                </div>

                <!-- –ü–µ—Ä–∏–æ–¥ -->
                <div class="col-auto" style="min-width: 150px;">
                    <label class="form-label small mb-1">–ü–µ—Ä–∏–æ–¥</label>
                    <select name="period" class="form-select form-select-sm" onchange="toggleCustomDates()">
                        <option value="today" {% if filters.period == 'today' %}selected{% endif %}>–°–µ–≥–æ–¥–Ω—è</option>
                        <option value="yesterday" {% if filters.period == 'yesterday' %}selected{% endif %}>–í—á–µ—Ä–∞</option>
                        <option value="week" {% if filters.period == 'week' %}selected{% endif %}>–≠—Ç–∞ –Ω–µ–¥–µ–ª—è</option>
                        <option value="last_week" {% if filters.period == 'last_week' %}selected{% endif %}>–ü—Ä–æ—à–ª–∞—è –Ω–µ–¥–µ–ª—è</option>
                        <option value="month" {% if filters.period == 'month' %}selected{% endif %}>–≠—Ç–æ—Ç –º–µ—Å—è—Ü</option>
                        <option value="custom" {% if filters.period == 'custom' %}selected{% endif %}>–°–≤–æ–π –ø–µ—Ä–∏–æ–¥</option>
                    </select>
                </div>

                <!-- –î–∞—Ç—ã (–¥–ª—è custom) -->
                <div class="col-auto" id="customDates" style="display: {% if filters.period == 'custom' %}block{% else %}none{% endif %}; min-width: 230px;">
                    <label class="form-label small mb-1">–û—Ç - –î–æ</label>
                    <div class="input-group input-group-sm">
                        <input type="date" name="date_from" class="form-control" value="{{ request.GET.date_from }}">
                        <input type="date" name="date_to" class="form-control" value="{{ request.GET.date_to }}">
                    </div>
                </div>

                <!-- –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö -->
                <div class="col-auto" style="min-width: 180px;">
                    <label class="form-label small mb-1">–¢–∏–ø –¥–∞–Ω–Ω—ã—Ö</label>
                    <select name="data_type" class="form-select form-select-sm">
                        <option value="MON" {% if filters.data_type == 'MON' or not filters.data_type %}selected{% endif %}>üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–≤—ã–µ</option>
                        <option value="EXP" {% if filters.data_type == 'EXP' %}selected{% endif %}>üë§ –≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–µ</option>
                        <option value="AI" {% if filters.data_type == 'AI' %}selected{% endif %}>ü§ñ –î–∞–Ω–Ω—ã–µ –ò–ò</option>
                    </select>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∞ –∞—Ç—Ä–∏–±—É—Ç–æ–≤ -->
                <div class="col-auto">
                    <label class="form-label small mb-1">&nbsp;</label>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleAttributeFilters()">
                        <i class="bi bi-funnel" id="attributeIcon"></i> –ê—Ç—Ä–∏–±—É—Ç—ã
                        <span class="badge bg-primary ms-1" id="attributeCount" style="display: none;">0</span>
                    </button>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏ -->
                <div class="col-auto ms-auto">
                    <label class="form-label small mb-1">&nbsp;</label>
                    <div class="btn-group">
                        <button type="submit" class="btn btn-primary btn-sm">
                            <i class="bi bi-search"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="resetFilters()">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- –†–∞—Å–∫—Ä—ã–≤–∞—é—â–∞—è—Å—è –ø–∞–Ω–µ–ª—å –∞—Ç—Ä–∏–±—É—Ç–æ–≤ -->
            <div id="attributeFiltersPanel" class="mt-3" style="display: none;">
                <hr class="my-2">
                <div class="row g-3">
                    {% for group in attribute_groups %}
                    <div class="col-md-12">
                        <h6 class="text-muted mb-2">{{ group.name }}</h6>
                        <div class="d-flex flex-wrap gap-2">
                            {% for attr in group.attributes.all %}
                            {% if attr.is_filterable %}
                                {% if attr.data_type == 'choice' or attr.data_type == 'multi_choice' %}
                                    {# –î–ª—è –≤—ã–±–æ—Ä–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ - –ø–æ–∫–∞–∑–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã –∏–∑ choices #}
                                    {% if attr.choices %}
                                        {% for choice in attr.choices %}
                                        <div class="form-check">
                                            <input class="form-check-input attribute-checkbox"
                                                   type="checkbox"
                                                   name="attr_{{ attr.code }}"
                                                   value="{{ choice }}"
                                                   id="attr_{{ attr.code }}_{{ forloop.counter }}"
                                                   onchange="updateAttributeCount()">
                                            <label class="form-check-label small" for="attr_{{ attr.code }}_{{ forloop.counter }}">
                                                {{ choice }}
                                            </label>
                                        </div>
                                        {% endfor %}
                                    {% endif %}
                                {% elif attr.data_type == 'boolean' %}
                                    {# –î–ª—è –î–∞/–ù–µ—Ç - –ø—Ä–æ—Å—Ç–æ–π —á–µ–∫–±–æ–∫—Å #}
                                    <div class="form-check">
                                        <input class="form-check-input attribute-checkbox"
                                               type="checkbox"
                                               name="attr_{{ attr.code }}"
                                               value="1"
                                               id="attr_{{ attr.code }}"
                                               onchange="updateAttributeCount()">
                                        <label class="form-check-label small" for="attr_{{ attr.code }}">
                                            {{ attr.name }}
                                        </label>
                                    </div>
                                {% endif %}
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-12">
                        <p class="text-muted small mb-0">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </form>
    </div>
</div>

<!-- –í–∏–¥–∂–µ—Ç—ã -->
{% if widgets %}
<div class="row" id="widgetsContainer">
    {% for widget in widgets %}
    {% if widget.type == 'metric' %}
    <!-- –ú–µ—Ç—Ä–∏–∫–∞ -->
    <div class="col-md-6 col-lg-3 mb-4">
        <div class="card border-{{ widget.color }} h-100">
            <div class="card-body text-center">
                <h6 class="text-muted text-uppercase small mb-2">{{ widget.title }}</h6>
                <h2 class="display-4 mb-0 text-{{ widget.color }}">
                    {{ widget.value|floatformat:2 }}
                    {% if widget.unit %}
                    <small class="text-muted fs-5">{{ widget.unit }}</small>
                    {% endif %}
                </h2>
            </div>
        </div>
    </div>

    {% elif widget.type == 'chart' %}
    <!-- –ì—Ä–∞—Ñ–∏–∫ Chart.js -->
    <div class="col-md-6 col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-light">
                <h5 class="mb-0">{{ widget.title }}</h5>
            </div>
            <div class="card-body">
                <canvas id="chart_{{ forloop.counter }}" height="200"></canvas>
            </div>
        </div>
    </div>
    <script>
    (function() {
        const chartType = '{{ widget.chart_type }}';
        const labels = {{ widget.labels|safe }};
        const values = {{ widget.values|safe }};
        const color = '{{ widget.color }}';

        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –≥—Ä–∞—Ñ–∏–∫–æ–≤
        let chartConfig = {
            type: chartType,
            data: {
                labels: labels,
                datasets: [{
                    label: '{{ widget.title }}',
                    data: values,
                    backgroundColor: color,
                    borderColor: color,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: ['pie', 'doughnut', 'polarArea', 'radar'].includes(chartType)
                    }
                }
            }
        };

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ª–∏–Ω–µ–π–Ω—ã—Ö –∏ —Å—Ç–æ–ª–±—á–∞—Ç—ã—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤
        if (['line', 'bar'].includes(chartType)) {
            chartConfig.data.datasets[0].tension = 0.4;
            chartConfig.data.datasets[0].fill = false;
            chartConfig.options.scales = {
                y: {
                    beginAtZero: true
                }
            };
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –±–∞—Ä–∞
        if (chartType === 'horizontalBar') {
            chartConfig.type = 'bar';
            chartConfig.options.indexAxis = 'y';
            chartConfig.options.scales = {
                x: {
                    beginAtZero: true
                }
            };
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –∫—Ä—É–≥–æ–≤—ã—Ö –¥–∏–∞–≥—Ä–∞–º–º
        if (['pie', 'doughnut', 'polarArea'].includes(chartType)) {
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–∞–∑–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤ –¥–ª—è —Å–µ–≥–º–µ–Ω—Ç–æ–≤
            const colors = [
                'rgba(255, 99, 132, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 206, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)',
                'rgba(255, 159, 64, 0.8)',
                'rgba(201, 203, 207, 0.8)',
                'rgba(255, 105, 180, 0.8)',
                'rgba(106, 90, 205, 0.8)',
                'rgba(255, 140, 0, 0.8)'
            ];
            chartConfig.data.datasets[0].backgroundColor = colors.slice(0, values.length);
            chartConfig.data.datasets[0].borderColor = '#fff';
            chartConfig.data.datasets[0].borderWidth = 2;
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ä–∞–¥–∞—Ä–∞
        if (chartType === 'radar') {
            chartConfig.data.datasets[0].fill = true;
            chartConfig.data.datasets[0].backgroundColor = color.replace(')', ', 0.2)');
            chartConfig.options.scales = {
                r: {
                    beginAtZero: true
                }
            };
        }

        new Chart(document.getElementById('chart_{{ forloop.counter }}'), chartConfig);
    })();
    </script>

    {% elif widget.type == 'table' %}
    <!-- –¢–∞–±–ª–∏—Ü–∞ -->
    <div class="col-md-12 col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-light">
                <h5 class="mb-0">{{ widget.title }}</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                {% if widget.group_by == 'outlet' %}
                                <th>–ö–æ–¥</th>
                                {% endif %}
                                <th class="text-end">–ó–Ω–∞—á–µ–Ω–∏–µ</th>
                                <th class="text-end">–ö–æ–ª-–≤–æ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in widget.rows %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>{{ row.name }}</td>
                                {% if widget.group_by == 'outlet' %}
                                <td><code>{{ row.code }}</code></td>
                                {% endif %}
                                <td class="text-end"><strong>{{ row.value }}</strong></td>
                                <td class="text-end"><span class="badge bg-secondary">{{ row.count }}</span></td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    {% elif widget.type == 'error' %}
    <!-- –û—à–∏–±–∫–∞ –≤–∏–¥–∂–µ—Ç–∞ -->
    <div class="col-md-6 col-lg-4 mb-4">
        <div class="card border-danger">
            <div class="card-body">
                <h6 class="text-danger"><i class="bi bi-exclamation-triangle"></i> {{ widget.title }}</h6>
                <small class="text-muted">{{ widget.error }}</small>
            </div>
        </div>
    </div>
    {% endif %}
    {% endfor %}
</div>
{% else %}
<div id="widgetsContainer" class="alert alert-info">
    <i class="bi bi-info-circle"></i>
    <strong>–î–∞—à–±–æ—Ä–¥ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è —ç—Ç–æ–≥–æ —É—Ä–æ–≤–Ω—è.</strong>
</div>
{% endif %}

<script>
let autoRefreshEnabled = false;
let autoRefreshInterval = null;
const REFRESH_INTERVAL = 60000; // 60 —Å–µ–∫—É–Ω–¥
let isLoading = false;

// AJAX –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞—à–±–æ—Ä–¥–∞
function updateDashboard() {
    if (isLoading) return;

    isLoading = true;
    const form = document.getElementById('filterForm');
    const formData = new FormData(form);
    const params = new URLSearchParams(formData);

    // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –≤—Å–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    const mainContent = document.querySelector('.container-fluid, .container');
    if (mainContent) {
        mainContent.style.opacity = '0.6';
        mainContent.style.pointerEvents = 'none';
    }

    // –û—Ç–ø—Ä–∞–≤–∏—Ç—å AJAX –∑–∞–ø—Ä–æ—Å
    fetch(window.location.pathname + '?' + params.toString(), {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.text())
    .then(html => {
        // –ü–∞—Ä—Å–∏–º –ø–æ–ª—É—á–µ–Ω–Ω—ã–π HTML
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');

        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å—é –∫–∞—Ä—Ç–æ—á–∫—É —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ (–≤–∫–ª—é—á–∞—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —É—Ä–æ–≤–Ω–µ–π)
        const newFilterCard = doc.querySelector('#filterCard');
        const currentFilterCard = document.getElementById('filterCard');
        if (newFilterCard && currentFilterCard) {
            currentFilterCard.innerHTML = newFilterCard.innerHTML;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∂–µ—Ç—ã
        const newWidgets = doc.querySelector('#widgetsContainer');
        const currentWidgets = document.getElementById('widgetsContainer');
        if (newWidgets && currentWidgets) {
            currentWidgets.outerHTML = newWidgets.outerHTML;
        }

        // –û–±–Ω–æ–≤–∏—Ç—å URL –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        const newUrl = window.location.pathname + '?' + params.toString();
        window.history.pushState({}, '', newUrl);

        // –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        reinitializeEventListeners();

        updateLastRefreshed();
        updateAttributeCount();
        isLoading = false;

        // –£–±—Ä–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        if (mainContent) {
            mainContent.style.opacity = '1';
            mainContent.style.pointerEvents = 'auto';
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞—à–±–æ—Ä–¥–∞:', error);
        isLoading = false;
        if (mainContent) {
            mainContent.style.opacity = '1';
            mainContent.style.pointerEvents = 'auto';
        }
    });
}

function changeLevel(level) {
    document.getElementById('levelInput').value = level;
    updateDashboard();
}

function refreshDashboard() {
    updateDashboard();
}

function toggleAutoRefresh() {
    autoRefreshEnabled = !autoRefreshEnabled;

    const icon = document.getElementById('autoRefreshIcon');
    const text = document.getElementById('autoRefreshText');
    const btn = document.getElementById('autoRefreshBtn');

    if (autoRefreshEnabled) {
        icon.className = 'bi bi-play-circle-fill';
        text.textContent = '–ê–≤—Ç–æ: –í–ö–õ';
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-success');

        autoRefreshInterval = setInterval(updateDashboard, REFRESH_INTERVAL);
        updateLastRefreshed();
    } else {
        icon.className = 'bi bi-pause-circle';
        text.textContent = '–ê–≤—Ç–æ: –í–´–ö–õ';
        btn.classList.remove('btn-success');
        btn.classList.add('btn-outline-secondary');

        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
        }
    }
}

function updateLastRefreshed() {
    const now = new Date();
    const elem = document.getElementById('lastUpdated');
    if (elem) {
        elem.textContent = `(–æ–±–Ω–æ–≤–ª–µ–Ω–æ ${now.toLocaleTimeString('ru-RU')})`;
    }
}

function resetFilters() {
    // –°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã
    document.querySelectorAll('select').forEach(select => {
        if (select.name !== 'level') {
            select.selectedIndex = 0;
        }
    });
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
    document.querySelectorAll('input[type="date"]').forEach(input => input.value = '');

    updateAttributeCount();
    updateDashboard();
}

function toggleCustomDates() {
    const period = document.querySelector('[name="period"]').value;
    const customDates = document.getElementById('customDates');
    customDates.style.display = period === 'custom' ? 'block' : 'none';
}

function toggleAttributeFilters() {
    const panel = document.getElementById('attributeFiltersPanel');
    const icon = document.getElementById('attributeIcon');

    if (panel.style.display === 'none') {
        panel.style.display = 'block';
        icon.classList.remove('bi-funnel');
        icon.classList.add('bi-funnel-fill');
    } else {
        panel.style.display = 'none';
        icon.classList.remove('bi-funnel-fill');
        icon.classList.add('bi-funnel');
    }
}

function updateAttributeCount() {
    const checkboxes = document.querySelectorAll('.attribute-checkbox:checked');
    const count = checkboxes.length;
    const badge = document.getElementById('attributeCount');

    if (count > 0) {
        badge.textContent = count;
        badge.style.display = 'inline';
    } else {
        badge.style.display = 'none';
    }
}

// –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–∞–π–º–∞—É—Ç–∞ –¥–∞—Ç
let dateTimeout;

// –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
function reinitializeEventListeners() {
    const form = document.getElementById('filterForm');
    if (!form) return;

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—Å–µ—Ö —Å–µ–ª–µ–∫—Ç–æ–≤
    form.querySelectorAll('select').forEach(select => {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (–∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞)
        const newSelect = select.cloneNode(true);
        select.parentNode.replaceChild(newSelect, select);

        newSelect.addEventListener('change', function() {
            if (this.name === 'period') {
                toggleCustomDates();
            }
            updateDashboard();
        });
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤ –∞—Ç—Ä–∏–±—É—Ç–æ–≤
    form.querySelectorAll('.attribute-checkbox').forEach(checkbox => {
        const newCheckbox = checkbox.cloneNode(true);
        checkbox.parentNode.replaceChild(newCheckbox, checkbox);

        newCheckbox.addEventListener('change', function() {
            updateAttributeCount();
            updateDashboard();
        });
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–ª–µ–π –¥–∞—Ç (—Å –∑–∞–¥–µ—Ä–∂–∫–æ–π)
    form.querySelectorAll('input[type="date"]').forEach(input => {
        const newInput = input.cloneNode(true);
        input.parentNode.replaceChild(newInput, input);

        newInput.addEventListener('change', function() {
            clearTimeout(dateTimeout);
            dateTimeout = setTimeout(() => {
                updateDashboard();
            }, 500);
        });
    });

    // –£–±—Ä–∞—Ç—å –∫–Ω–æ–ø–∫—É "–ü—Ä–∏–º–µ–Ω–∏—Ç—å" - –æ–Ω–∞ –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–∞
    const submitBtn = form.querySelector('button[type="submit"]');
    if (submitBtn) {
        submitBtn.style.display = 'none';
    }

    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        return false;
    });
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
document.addEventListener('DOMContentLoaded', function() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ
    reinitializeEventListeners();

    // –ü–æ–∫–∞–∑–∞—Ç—å –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    updateLastRefreshed();
    // –û–±–Ω–æ–≤–∏—Ç—å —Å—á—ë—Ç—á–∏–∫ –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    updateAttributeCount();
});
</script>
{% endblock %}
