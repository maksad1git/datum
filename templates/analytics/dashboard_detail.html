{% extends 'base.html' %}

{% block title %}{{ dashboard.name }} - Datum{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1 class="h2">
            <i class="bi bi-graph-up"></i> {{ dashboard.name }}
            <span id="lastUpdated" class="small text-muted"></span>
        </h1>
        {% if dashboard.description %}
        <p class="text-muted">{{ dashboard.description }}</p>
        {% endif %}
    </div>
    <div class="col-auto">
        <div class="btn-group">
            <button class="btn btn-outline-secondary btn-sm" onclick="toggleAutoRefresh()" id="autoRefreshBtn">
                <i id="autoRefreshIcon" class="bi bi-pause-circle"></i>
                <span id="autoRefreshText">–ê–≤—Ç–æ</span>
            </button>
            <button class="btn btn-primary btn-sm" onclick="refreshDashboard()">
                <i class="bi bi-arrow-clockwise"></i> –û–±–Ω–æ–≤–∏—Ç—å
            </button>
        </div>
        <a href="{% url 'analytics:dashboard_update' dashboard.pk %}" class="btn btn-warning btn-sm">
            <i class="bi bi-pencil"></i> –ù–∞—Å—Ç—Ä–æ–∏—Ç—å
        </a>
        <a href="{% url 'analytics:dashboard_list' %}" class="btn btn-secondary btn-sm">
            <i class="bi bi-arrow-left"></i> –ö —Å–ø–∏—Å–∫—É
        </a>
    </div>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã -->
<div class="card mb-4">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-funnel"></i> –§–∏–ª—å—Ç—Ä—ã</h5>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="resetFilters()">
                <i class="bi bi-arrow-clockwise"></i> –°–±—Ä–æ—Å–∏—Ç—å
            </button>
        </div>
    </div>
    <div class="card-body">
        <form method="get" id="filterForm">
            <div class="row g-3">
                <!-- –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö (–í–ê–ñ–ù–û - –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å!) -->
                <div class="col-md-2">
                    <label class="form-label"><strong>–¢–∏–ø –¥–∞–Ω–Ω—ã—Ö</strong></label>
                    <select name="data_type" class="form-select form-select-sm">
                        <option value="MON" {% if filters.data_type == 'MON' or not filters.data_type %}selected{% endif %}>üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–≤—ã–µ</option>
                        <option value="EXP" {% if filters.data_type == 'EXP' %}selected{% endif %}>üë§ –≠–∫—Å–ø–µ—Ä—Ç–Ω—ã–µ</option>
                        <option value="AI" {% if filters.data_type == 'AI' %}selected{% endif %}>ü§ñ –î–∞–Ω–Ω—ã–µ –ò–ò</option>
                    </select>
                </div>

                <!-- –ü–µ—Ä–∏–æ–¥ -->
                <div class="col-md-2">
                    <label class="form-label">–ü–µ—Ä–∏–æ–¥</label>
                    <select name="period" class="form-select form-select-sm" onchange="toggleCustomDates()">
                        <option value="today" {% if filters.period == 'today' %}selected{% endif %}>–°–µ–≥–æ–¥–Ω—è</option>
                        <option value="yesterday" {% if filters.period == 'yesterday' %}selected{% endif %}>–í—á–µ—Ä–∞</option>
                        <option value="week" {% if filters.period == 'week' %}selected{% endif %}>–≠—Ç–∞ –Ω–µ–¥–µ–ª—è</option>
                        <option value="last_week" {% if filters.period == 'last_week' %}selected{% endif %}>–ü—Ä–æ—à–ª–∞—è –Ω–µ–¥–µ–ª—è</option>
                        <option value="month" {% if filters.period == 'month' %}selected{% endif %}>–≠—Ç–æ—Ç –º–µ—Å—è—Ü</option>
                        <option value="custom" {% if filters.period == 'custom' %}selected{% endif %}>–°–≤–æ–π –ø–µ—Ä–∏–æ–¥</option>
                    </select>
                </div>

                <!-- –î–∞—Ç—ã (–¥–ª—è custom) -->
                <div class="col-md-3" id="customDates" style="display: {% if filters.period == 'custom' %}block{% else %}none{% endif %};">
                    <label class="form-label">–û—Ç - –î–æ</label>
                    <div class="input-group input-group-sm">
                        <input type="date" name="date_from" class="form-control" value="{{ request.GET.date_from }}">
                        <input type="date" name="date_to" class="form-control" value="{{ request.GET.date_to }}">
                    </div>
                </div>
            </div>

            <div class="row g-3 mt-2">
                <!-- –°—Ç—Ä–∞–Ω–∞ -->
                <div class="col-md-2">
                    <label class="form-label">üåç –°—Ç—Ä–∞–Ω–∞</label>
                    <select name="country" class="form-select form-select-sm">
                        <option value="">–í—Å–µ —Å—Ç—Ä–∞–Ω—ã</option>
                        {% for country in countries %}
                        <option value="{{ country.id }}" {% if filters.country|stringformat:"s" == country.id|stringformat:"s" %}selected{% endif %}>
                            {{ country.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- –†–µ–≥–∏–æ–Ω -->
                <div class="col-md-2">
                    <label class="form-label">üèôÔ∏è –ì–æ—Ä–æ–¥/–†–µ–≥–∏–æ–Ω</label>
                    <select name="region" class="form-select form-select-sm">
                        <option value="">–í—Å–µ —Ä–µ–≥–∏–æ–Ω—ã</option>
                        {% for region in regions %}
                        <option value="{{ region.id }}" {% if filters.region|stringformat:"s" == region.id|stringformat:"s" %}selected{% endif %}>
                            {{ region.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- –ö–∞–Ω–∞–ª -->
                <div class="col-md-2">
                    <label class="form-label">üì¢ –ö–∞–Ω–∞–ª —Å–±—ã—Ç–∞</label>
                    <select name="channel" class="form-select form-select-sm">
                        <option value="">–í—Å–µ –∫–∞–Ω–∞–ª—ã</option>
                        {% for channel in channels %}
                        <option value="{{ channel.id }}" {% if filters.channel|stringformat:"s" == channel.id|stringformat:"s" %}selected{% endif %}>
                            {{ channel.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- –¢–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞ -->
                <div class="col-md-5">
                    <label class="form-label">üè™ –¢–æ—Ä–≥–æ–≤–∞—è —Ç–æ—á–∫–∞</label>
                    <select name="outlet" class="form-select form-select-sm">
                        <option value="">–í—Å–µ —Ç–æ—á–∫–∏</option>
                        {% for outlet in outlets %}
                        <option value="{{ outlet.id }}" {% if filters.outlet|stringformat:"s" == outlet.id|stringformat:"s" %}selected{% endif %}>
                            {{ outlet.name }} ({{ outlet.channel.name }})
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∞ -->
                <div class="col-md-1 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary btn-sm w-100">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- –í–∏–¥–∂–µ—Ç—ã -->
{% if widgets %}
<div class="row">
    {% for widget in widgets %}
    {% if widget.type == 'metric' %}
    <!-- –ú–µ—Ç—Ä–∏–∫–∞ -->
    <div class="col-md-6 col-lg-3 mb-4">
        <div class="card border-{{ widget.color }} h-100">
            <div class="card-body text-center">
                <h6 class="text-muted text-uppercase small mb-2">{{ widget.title }}</h6>
                <h2 class="display-4 mb-0 text-{{ widget.color }}">
                    {{ widget.value|floatformat:2 }}
                    {% if widget.unit %}
                    <small class="text-muted fs-5">{{ widget.unit }}</small>
                    {% endif %}
                </h2>
            </div>
        </div>
    </div>

    {% elif widget.type == 'chart' %}
    <!-- –ì—Ä–∞—Ñ–∏–∫ Chart.js -->
    <div class="col-md-6 col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-light">
                <h5 class="mb-0">{{ widget.title }}</h5>
            </div>
            <div class="card-body">
                <canvas id="chart_{{ forloop.counter }}" height="200"></canvas>
            </div>
        </div>
    </div>
    <script>
    (function() {
        const chartType = '{{ widget.chart_type }}';
        const labels = {{ widget.labels|safe }};
        const values = {{ widget.values|safe }};
        const color = '{{ widget.color }}';

        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –≥—Ä–∞—Ñ–∏–∫–æ–≤
        let chartConfig = {
            type: chartType,
            data: {
                labels: labels,
                datasets: [{
                    label: '{{ widget.title }}',
                    data: values,
                    backgroundColor: color,
                    borderColor: color,
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: ['pie', 'doughnut', 'polarArea', 'radar'].includes(chartType)
                    }
                }
            }
        };

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ª–∏–Ω–µ–π–Ω—ã—Ö –∏ —Å—Ç–æ–ª–±—á–∞—Ç—ã—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤
        if (['line', 'bar'].includes(chartType)) {
            chartConfig.data.datasets[0].tension = 0.4;
            chartConfig.data.datasets[0].fill = false;
            chartConfig.options.scales = {
                y: {
                    beginAtZero: true
                }
            };
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –±–∞—Ä–∞
        if (chartType === 'horizontalBar') {
            chartConfig.type = 'bar';
            chartConfig.options.indexAxis = 'y';
            chartConfig.options.scales = {
                x: {
                    beginAtZero: true
                }
            };
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –∫—Ä—É–≥–æ–≤—ã—Ö –¥–∏–∞–≥—Ä–∞–º–º
        if (['pie', 'doughnut', 'polarArea'].includes(chartType)) {
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–∞–∑–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤ –¥–ª—è —Å–µ–≥–º–µ–Ω—Ç–æ–≤
            const colors = [
                'rgba(255, 99, 132, 0.8)',
                'rgba(54, 162, 235, 0.8)',
                'rgba(255, 206, 86, 0.8)',
                'rgba(75, 192, 192, 0.8)',
                'rgba(153, 102, 255, 0.8)',
                'rgba(255, 159, 64, 0.8)',
                'rgba(201, 203, 207, 0.8)',
                'rgba(255, 105, 180, 0.8)',
                'rgba(106, 90, 205, 0.8)',
                'rgba(255, 140, 0, 0.8)'
            ];
            chartConfig.data.datasets[0].backgroundColor = colors.slice(0, values.length);
            chartConfig.data.datasets[0].borderColor = '#fff';
            chartConfig.data.datasets[0].borderWidth = 2;
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ä–∞–¥–∞—Ä–∞
        if (chartType === 'radar') {
            chartConfig.data.datasets[0].fill = true;
            chartConfig.data.datasets[0].backgroundColor = color.replace(')', ', 0.2)');
            chartConfig.options.scales = {
                r: {
                    beginAtZero: true
                }
            };
        }

        new Chart(document.getElementById('chart_{{ forloop.counter }}'), chartConfig);
    })();
    </script>

    {% elif widget.type == 'table' %}
    <!-- –¢–∞–±–ª–∏—Ü–∞ -->
    <div class="col-md-12 col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-light">
                <h5 class="mb-0">{{ widget.title }}</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                {% if widget.group_by == 'outlet' %}
                                <th>–ö–æ–¥</th>
                                {% endif %}
                                <th class="text-end">–ó–Ω–∞—á–µ–Ω–∏–µ</th>
                                <th class="text-end">–ö–æ–ª-–≤–æ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in widget.rows %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>{{ row.name }}</td>
                                {% if widget.group_by == 'outlet' %}
                                <td><code>{{ row.code }}</code></td>
                                {% endif %}
                                <td class="text-end"><strong>{{ row.value }}</strong></td>
                                <td class="text-end"><span class="badge bg-secondary">{{ row.count }}</span></td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    {% elif widget.type == 'error' %}
    <!-- –û—à–∏–±–∫–∞ –≤–∏–¥–∂–µ—Ç–∞ -->
    <div class="col-md-6 col-lg-4 mb-4">
        <div class="card border-danger">
            <div class="card-body">
                <h6 class="text-danger"><i class="bi bi-exclamation-triangle"></i> {{ widget.title }}</h6>
                <small class="text-muted">{{ widget.error }}</small>
            </div>
        </div>
    </div>
    {% endif %}
    {% endfor %}
</div>
{% else %}
<div class="alert alert-info">
    <i class="bi bi-info-circle"></i>
    <strong>–î–∞—à–±–æ—Ä–¥ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.</strong>
    <a href="{% url 'analytics:dashboard_update' dashboard.pk %}">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≤–∏–¥–∂–µ—Ç—ã</a>
    <hr>
    <small class="text-muted">
        <strong>–ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (JSON):</strong>
        <pre class="mb-0 mt-2">{
  "widgets": [
    {
      "type": "metric",
      "title": "–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞",
      "coefficient_id": 1,
      "aggregation": "avg",
      "unit": "‚ÇΩ",
      "color": "primary"
    },
    {
      "type": "chart",
      "title": "–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –¥–Ω—è–º",
      "coefficient_id": 1,
      "chart_type": "line",
      "group_by": "date",
      "color": "rgba(75, 192, 192, 0.8)"
    }
  ]
}</pre>
    </small>
</div>
{% endif %}

<script>
let autoRefreshEnabled = false;
let autoRefreshInterval = null;
const REFRESH_INTERVAL = 60000; // 60 —Å–µ–∫—É–Ω–¥

function refreshDashboard() {
    location.reload();
}

function toggleAutoRefresh() {
    autoRefreshEnabled = !autoRefreshEnabled;

    const icon = document.getElementById('autoRefreshIcon');
    const text = document.getElementById('autoRefreshText');
    const btn = document.getElementById('autoRefreshBtn');

    if (autoRefreshEnabled) {
        icon.className = 'bi bi-play-circle-fill';
        text.textContent = '–ê–≤—Ç–æ: –í–ö–õ';
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-success');

        autoRefreshInterval = setInterval(refreshDashboard, REFRESH_INTERVAL);
        updateLastRefreshed();
    } else {
        icon.className = 'bi bi-pause-circle';
        text.textContent = '–ê–≤—Ç–æ: –í–´–ö–õ';
        btn.classList.remove('btn-success');
        btn.classList.add('btn-outline-secondary');

        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
        }
    }
}

function updateLastRefreshed() {
    const now = new Date();
    document.getElementById('lastUpdated').textContent =
        `(–æ–±–Ω–æ–≤–ª–µ–Ω–æ ${now.toLocaleTimeString('ru-RU')})`;
}

function resetFilters() {
    window.location.href = window.location.pathname;
}

function toggleCustomDates() {
    const period = document.querySelector('[name="period"]').value;
    const customDates = document.getElementById('customDates');
    customDates.style.display = period === 'custom' ? 'block' : 'none';
}

// –ü–æ–∫–∞–∑–∞—Ç—å –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
updateLastRefreshed();
</script>
{% endblock %}
