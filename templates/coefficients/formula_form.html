{% extends 'base.html' %}

{% block title %}{% if object %}Редактировать {{ object.name }}{% else %}Создать формулу{% endif %} - Datum{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1 class="h2">
            <i class="bi bi-calculator-fill"></i>
            {% if object %}
                Редактировать: {{ object.name }}
            {% else %}
                Создать формулу
            {% endif %}
        </h1>
    </div>
</div>

<form method="post" id="formulaForm">
    {% csrf_token %}

    <div class="row">
        <div class="col-lg-8">
            <!-- Основные настройки -->
            <div class="card mb-3">
                <div class="card-body">
                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ form.non_field_errors }}
                        </div>
                    {% endif %}

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.name.id_for_label }}" class="form-label fw-bold">
                                {{ form.name.label }}
                                {% if form.name.field.required %}<span class="text-danger">*</span>{% endif %}
                            </label>
                            {{ form.name }}
                            {% if form.name.errors %}
                                <div class="invalid-feedback d-block">{{ form.name.errors }}</div>
                            {% endif %}
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ form.code.id_for_label }}" class="form-label fw-bold">
                                {{ form.code.label }}
                                {% if form.code.field.required %}<span class="text-danger">*</span>{% endif %}
                            </label>
                            {{ form.code }}
                            {% if form.code.errors %}
                                <div class="invalid-feedback d-block">{{ form.code.errors }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.description.id_for_label }}" class="form-label">{{ form.description.label }}</label>
                        {{ form.description }}
                        {% if form.description.errors %}
                            <div class="invalid-feedback d-block">{{ form.description.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3 form-check">
                        {{ form.is_active }}
                        <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                            {{ form.is_active.label }}
                        </label>
                    </div>
                </div>
            </div>

            <!-- Визуальный конструктор формулы -->
            <div class="card mb-3">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-calculator"></i> Конструктор формулы</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small">Постройте формулу визуально, используя коэффициенты и операции</p>

                    <!-- Скрытое поле для Django -->
                    <input type="hidden" name="expression" id="expressionInput" value="{{ form.expression.value|default:'' }}">

                    <!-- Предварительный просмотр формулы -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Формула:</label>
                        <div id="formulaPreview" class="p-3 bg-light border rounded font-monospace">
                            <span class="text-muted">Формула пуста - добавьте элементы</span>
                        </div>
                        {% if form.expression.errors %}
                            <div class="invalid-feedback d-block">{{ form.expression.errors }}</div>
                        {% endif %}
                    </div>

                    <!-- Кнопки для построения формулы -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Добавить в формулу:</label>
                        <div class="d-flex flex-wrap gap-2">
                            <button type="button" class="btn btn-outline-primary" onclick="addCoefficient()">
                                <i class="bi bi-graph-up"></i> Коэффициент
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="addOperator('+')">+</button>
                            <button type="button" class="btn btn-outline-secondary" onclick="addOperator('-')">-</button>
                            <button type="button" class="btn btn-outline-secondary" onclick="addOperator('*')">×</button>
                            <button type="button" class="btn btn-outline-secondary" onclick="addOperator('/')">/</button>
                            <button type="button" class="btn btn-outline-secondary" onclick="addOperator('(')">(</button>
                            <button type="button" class="btn btn-outline-secondary" onclick="addOperator(')')">)</button>
                            <button type="button" class="btn btn-outline-info" onclick="addFunction()">
                                <i class="bi bi-code-square"></i> Функция
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="clearFormula()">
                                <i class="bi bi-trash"></i> Очистить
                            </button>
                        </div>
                    </div>

                    <!-- Доступные функции -->
                    <div class="alert alert-light small mb-0">
                        <strong>Доступные функции:</strong>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <ul class="mb-0">
                                    <li><code>AVG(C1)</code> - среднее значение</li>
                                    <li><code>SUM(C1)</code> - сумма значений</li>
                                    <li><code>MIN(C1)</code> - минимум</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <ul class="mb-0">
                                    <li><code>MAX(C1)</code> - максимум</li>
                                    <li><code>COUNT(C1)</code> - количество</li>
                                    <li><code>COUNT(*)</code> - всего записей</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-success btn-lg">
                    <i class="bi bi-check-circle"></i> Сохранить
                </button>
                <a href="{% if object %}{% url 'coefficients:formula_detail' object.pk %}{% else %}{% url 'coefficients:formula_list' %}{% endif %}" class="btn btn-secondary btn-lg">
                    <i class="bi bi-x-circle"></i> Отмена
                </a>
            </div>
        </div>

        <!-- Правая панель: Справка -->
        <div class="col-lg-4">
            <div class="card bg-light sticky-top" style="top: 20px;">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Справка</h5>
                </div>
                <div class="card-body">
                    <h6><i class="bi bi-lightbulb"></i> Что такое формула?</h6>
                    <p class="small">Формула - это математическое выражение для вычисления метрики на основе коэффициентов.</p>

                    <hr>

                    <h6><i class="bi bi-code-square"></i> Как использовать</h6>
                    <ol class="small">
                        <li>Нажмите "Коэффициент" и выберите из списка</li>
                        <li>Добавьте операторы (+, -, ×, /)</li>
                        <li>Используйте функции (AVG, SUM и т.д.)</li>
                        <li>Скобки для приоритета операций</li>
                    </ol>

                    <hr>

                    <h6><i class="bi bi-box"></i> Примеры формул</h6>

                    <div class="mb-3">
                        <strong class="small">Средняя цена:</strong>
                        <pre class="small mb-0 bg-white p-2 rounded">AVG(C1)</pre>
                    </div>

                    <div class="mb-3">
                        <strong class="small">Процент наличия:</strong>
                        <pre class="small mb-0 bg-white p-2 rounded">(COUNT(C1) / COUNT(*)) * 100</pre>
                    </div>

                    <div class="mb-3">
                        <strong class="small">Разница цен:</strong>
                        <pre class="small mb-0 bg-white p-2 rounded">MAX(C1) - MIN(C1)</pre>
                    </div>

                    <div class="mb-3">
                        <strong class="small">Средняя маржа:</strong>
                        <pre class="small mb-0 bg-white p-2 rounded">((C1 - C2) / C1) * 100</pre>
                        <small class="text-muted">где C1 - цена, C2 - себестоимость</small>
                    </div>

                    <hr>

                    <div class="alert alert-success small mb-0">
                        <strong>Совет:</strong> Создайте универсальные формулы типа "Среднее", "Сумма", "Процент" и используйте их для разных метрик.
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Модальное окно выбора коэффициента -->
<div class="modal fade" id="coefficientModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Выбрать коэффициент</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="text" class="form-control mb-3" id="coefficientSearch" placeholder="Поиск коэффициента...">
                <div id="coefficientList" style="max-height: 400px; overflow-y: auto;">
                    <div class="alert alert-info">
                        <i class="bi bi-hourglass-split"></i> Загрузка коэффициентов...
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно выбора функции -->
<div class="modal fade" id="functionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Выбрать функцию</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="list-group">
                    <button type="button" class="list-group-item list-group-item-action" onclick="selectFunction('AVG')">
                        <strong>AVG(C)</strong> - Среднее значение
                    </button>
                    <button type="button" class="list-group-item list-group-item-action" onclick="selectFunction('SUM')">
                        <strong>SUM(C)</strong> - Сумма значений
                    </button>
                    <button type="button" class="list-group-item list-group-item-action" onclick="selectFunction('MIN')">
                        <strong>MIN(C)</strong> - Минимальное значение
                    </button>
                    <button type="button" class="list-group-item list-group-item-action" onclick="selectFunction('MAX')">
                        <strong>MAX(C)</strong> - Максимальное значение
                    </button>
                    <button type="button" class="list-group-item list-group-item-action" onclick="selectFunction('COUNT')">
                        <strong>COUNT(C)</strong> - Количество значений
                    </button>
                    <button type="button" class="list-group-item list-group-item-action" onclick="selectFunction('COUNT(*)')">
                        <strong>COUNT(*)</strong> - Всего записей
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.coefficient-item {
    padding: 10px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.2s;
}

.coefficient-item:hover {
    background: #f8f9fa;
    border-color: #198754;
}
</style>

<script>
let allCoefficients = [];
let currentExpression = "{{ form.expression.value|default:'' }}";
let coefficientMap = new Map(); // Map coefficient index to coefficient data

// Загрузить коэффициенты при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    // Загрузить все доступные коэффициенты
    fetch('/api/coefficients/')
        .then(response => response.json())
        .then(data => {
            allCoefficients = data;
            console.log('Loaded coefficients:', allCoefficients);
        })
        .catch(error => {
            console.error('Error loading coefficients:', error);
        });

    // Показать текущее выражение если есть
    if (currentExpression) {
        updateFormulaPreview();
    }
});

function addCoefficient() {
    const modal = new bootstrap.Modal(document.getElementById('coefficientModal'));
    renderCoefficientList();
    modal.show();
}

function renderCoefficientList() {
    const container = document.getElementById('coefficientList');
    const searchInput = document.getElementById('coefficientSearch');
    const search = searchInput ? searchInput.value.toLowerCase() : '';

    if (allCoefficients.length === 0) {
        container.innerHTML = '<div class="alert alert-info">Загрузка коэффициентов...</div>';
        return;
    }

    const filtered = allCoefficients.filter(c =>
        c.name.toLowerCase().includes(search) ||
        c.code.toLowerCase().includes(search)
    );

    if (filtered.length === 0) {
        container.innerHTML = '<div class="alert alert-warning">Коэффициенты не найдены</div>';
        return;
    }

    container.innerHTML = filtered.map(coef => `
        <div class="coefficient-item" onclick="selectCoefficient(${coef.id}, '${coef.name}', '${coef.code}')">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>${coef.name}</strong>
                    <small class="text-muted d-block">${coef.code}${coef.unit ? ' (' + coef.unit + ')' : ''}</small>
                </div>
                <i class="bi bi-arrow-right-circle text-success fs-4"></i>
            </div>
        </div>
    `).join('');
}

function selectCoefficient(id, name, code) {
    // Найти или создать индекс для этого коэффициента
    let coeffIndex = null;
    for (let [index, data] of coefficientMap.entries()) {
        if (data.id === id) {
            coeffIndex = index;
            break;
        }
    }

    if (coeffIndex === null) {
        // Создать новый индекс
        coeffIndex = coefficientMap.size + 1;
        coefficientMap.set(coeffIndex, { id, name, code });
    }

    // Добавить в формулу
    if (currentExpression && !currentExpression.endsWith(' ')) {
        currentExpression += ' ';
    }
    currentExpression += `C${coeffIndex}`;

    updateFormulaPreview();

    // Закрыть модальное окно
    bootstrap.Modal.getInstance(document.getElementById('coefficientModal')).hide();
}

function addOperator(op) {
    if (currentExpression && !currentExpression.endsWith(' ') && op !== '(' && op !== ')') {
        currentExpression += ' ';
    }
    currentExpression += op;
    if (op !== '(' && op !== ')') {
        currentExpression += ' ';
    }
    updateFormulaPreview();
}

function addFunction() {
    const modal = new bootstrap.Modal(document.getElementById('functionModal'));
    modal.show();
}

function selectFunction(funcName) {
    if (currentExpression && !currentExpression.endsWith(' ')) {
        currentExpression += ' ';
    }

    if (funcName === 'COUNT(*)') {
        currentExpression += 'COUNT(*)';
    } else {
        currentExpression += funcName + '(';
    }

    updateFormulaPreview();

    // Закрыть модальное окно
    bootstrap.Modal.getInstance(document.getElementById('functionModal')).hide();
}

function clearFormula() {
    if (confirm('Очистить формулу?')) {
        currentExpression = '';
        coefficientMap.clear();
        updateFormulaPreview();
    }
}

function updateFormulaPreview() {
    const preview = document.getElementById('formulaPreview');
    const input = document.getElementById('expressionInput');

    if (!currentExpression || currentExpression.trim() === '') {
        preview.innerHTML = '<span class="text-muted">Формула пуста - добавьте элементы</span>';
        input.value = '';
        return;
    }

    // Создать красивое отображение с подсказками
    let displayFormula = currentExpression;

    // Добавить подсказки для коэффициентов
    coefficientMap.forEach((data, index) => {
        const regex = new RegExp(`C${index}`, 'g');
        displayFormula = displayFormula.replace(
            regex,
            `<span class="badge bg-primary" title="${data.name} (${data.code})">C${index}</span>`
        );
    });

    preview.innerHTML = displayFormula;
    input.value = currentExpression.trim();
}

// Поиск коэффициентов
document.getElementById('coefficientSearch')?.addEventListener('input', renderCoefficientList);
</script>
{% endblock %}
